name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_approval:
        description: 'Skip manual approval (use with caution)'
        required: false
        default: 'false'
      rollback_version:
        description: 'Rollback to specific version (leave empty for normal deploy)'
        required: false
        default: ''

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
  DEPLOY_ENVIRONMENT: production

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    
    outputs:
      can_deploy: ${{ steps.checks.outputs.can_deploy }}
      migration_safe: ${{ steps.db_check.outputs.migration_safe }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if staging is healthy
        id: staging_health
        run: |
          STAGING_URL="${{ secrets.STAGING_URL || 'https://staging.goumuve.com' }}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" $STAGING_URL/api/health || echo "000")
          
          if [[ "$STATUS" == "200" ]]; then
            echo "âœ… Staging is healthy"
            echo "healthy=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Staging is unhealthy (HTTP $STATUS)"
            echo "healthy=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check database migration safety
        id: db_check
        run: |
          # Check if there are new migration files
          MIGRATIONS=$(git diff --name-only origin/main..HEAD | grep -E "migrations/.*\.py$" || echo "")
          
          if [[ -n "$MIGRATIONS" ]]; then
            echo "âš ï¸  Database migrations detected:"
            echo "$MIGRATIONS"
            
            # Check for potentially dangerous operations
            DANGEROUS=$(git diff origin/main..HEAD -- $MIGRATIONS | grep -E "(DROP TABLE|DROP COLUMN|ALTER TABLE.*DROP)" || echo "")
            
            if [[ -n "$DANGEROUS" ]]; then
              echo "âš ï¸  DANGEROUS operations detected - manual review required"
              echo "migration_safe=false" >> $GITHUB_OUTPUT
            else
              echo "âœ… Migrations appear safe (additive only)"
              echo "migration_safe=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… No database migrations"
            echo "migration_safe=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate deployment readiness
        id: checks
        run: |
          STAGING_HEALTHY="${{ steps.staging_health.outputs.healthy }}"
          MIGRATION_SAFE="${{ steps.db_check.outputs.migration_safe }}"
          
          if [[ "$STAGING_HEALTHY" == "true" ]] && [[ "$MIGRATION_SAFE" == "true" ]]; then
            echo "can_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… All pre-deployment checks passed"
          else
            echo "can_deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ Pre-deployment checks failed"
            
            if [[ "${{ github.event.inputs.skip_approval }}" != "true" ]]; then
              exit 1
            fi
          fi

  manual-approval:
    name: Manual Approval Required
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: github.event.inputs.skip_approval != 'true'
    environment:
      name: production
      url: ${{ secrets.PRODUCTION_URL || 'https://goumuve.com' }}
    
    steps:
      - name: Wait for approval
        run: |
          echo "â³ Waiting for manual approval to deploy to production..."
          echo "Migration safe: ${{ needs.pre-deployment-checks.outputs.migration_safe }}"
          echo "Deploying commit: ${{ github.sha }}"

  build-and-push:
    name: Build & Push Production Images
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, manual-approval]
    if: |
      always() && 
      needs.pre-deployment-checks.result == 'success' &&
      (needs.manual-approval.result == 'success' || github.event.inputs.skip_approval == 'true')
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        service: [backend, frontend, dashboard]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=prod-,format=short
            type=semver,pattern={{version}}
            type=raw,value=production-latest
            type=raw,value=prod-${{ github.run_number }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=prod-${{ github.run_number }}

  database-migration:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: [build-and-push, pre-deployment-checks]
    if: needs.pre-deployment-checks.outputs.migration_safe == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: backend
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Backup database
        run: |
          echo "ðŸ—„ï¸  Creating database backup before migration..."
          # This would integrate with your backup solution
          # For AWS RDS, you might create a snapshot
          # For Railway, you might use their backup API
      
      - name: Run migrations with rollback capability
        working-directory: backend
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
        run: |
          echo "ðŸ“Š Running database migrations..."
          
          # Store current migration version for rollback
          CURRENT_VERSION=$(flask db current 2>/dev/null || echo "none")
          echo "Current version: $CURRENT_VERSION"
          echo "ROLLBACK_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
          
          # Run migrations
          flask db upgrade || {
            echo "âŒ Migration failed! Rolling back..."
            flask db downgrade $CURRENT_VERSION
            exit 1
          }
          
          echo "âœ… Migrations completed successfully"

  deploy-blue:
    name: Deploy Blue Environment
    runs-on: ubuntu-latest
    needs: [build-and-push, database-migration]
    if: |
      always() && 
      needs.build-and-push.result == 'success' &&
      (needs.database-migration.result == 'success' || needs.database-migration.result == 'skipped')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        if: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
      
      - name: Deploy to Blue environment
        run: |
          echo "ðŸ”µ Deploying to BLUE environment..."
          
          # Update ECS task definition with new image
          aws ecs update-service \
            --cluster umuve-production \
            --service backend-blue \
            --force-new-deployment \
            --region ${{ secrets.AWS_REGION || 'us-east-1' }}
          
          aws ecs update-service \
            --cluster umuve-production \
            --service frontend-blue \
            --force-new-deployment \
            --region ${{ secrets.AWS_REGION || 'us-east-1' }}
          
          aws ecs update-service \
            --cluster umuve-production \
            --service dashboard-blue \
            --force-new-deployment \
            --region ${{ secrets.AWS_REGION || 'us-east-1' }}
      
      - name: Wait for Blue to stabilize
        run: |
          echo "â³ Waiting for Blue environment to stabilize..."
          aws ecs wait services-stable \
            --cluster umuve-production \
            --services backend-blue frontend-blue dashboard-blue \
            --region ${{ secrets.AWS_REGION || 'us-east-1' }}
      
      - name: Health check Blue environment
        id: blue_health
        run: |
          BLUE_URL="${{ secrets.BLUE_INTERNAL_URL || 'https://blue.goumuve.com' }}"
          
          echo "ðŸ¥ Running health checks on Blue environment..."
          sleep 30  # Give services time to fully start
          
          for i in {1..5}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" $BLUE_URL/api/health || echo "000")
            
            if [[ "$STATUS" == "200" ]]; then
              echo "âœ… Blue environment is healthy"
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "â³ Health check $i/5 failed (HTTP $STATUS), retrying..."
            sleep 10
          done
          
          echo "âŒ Blue environment health checks failed"
          echo "healthy=false" >> $GITHUB_OUTPUT
          exit 1

  smoke-test-blue:
    name: Smoke Test Blue Environment
    runs-on: ubuntu-latest
    needs: deploy-blue
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run smoke tests on Blue
        env:
          BASE_URL: ${{ secrets.BLUE_INTERNAL_URL || 'https://blue.goumuve.com' }}
        run: |
          cd e2e
          npm ci || npm install playwright @playwright/test
          npx playwright test smoke --project=chromium
        timeout-minutes: 10
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blue-smoke-test-results
          path: e2e/test-results/
          retention-days: 7

  switch-traffic:
    name: Switch Traffic to Blue (Green â†’ Blue)
    runs-on: ubuntu-latest
    needs: [deploy-blue, smoke-test-blue]
    
    steps:
      - name: Switch load balancer to Blue
        run: |
          echo "ðŸ”„ Switching traffic from Green to Blue..."
          
          # Update target group or load balancer to point to Blue
          aws elbv2 modify-listener \
            --listener-arn ${{ secrets.PRODUCTION_LISTENER_ARN }} \
            --default-actions Type=forward,TargetGroupArn=${{ secrets.BLUE_TARGET_GROUP_ARN }} \
            --region ${{ secrets.AWS_REGION || 'us-east-1' }}
          
          echo "âœ… Traffic switched to Blue environment"
      
      - name: Monitor traffic switch
        run: |
          echo "ðŸ“Š Monitoring traffic switch for 2 minutes..."
          sleep 120
          
          # Check error rates
          PROD_URL="${{ secrets.PRODUCTION_URL || 'https://goumuve.com' }}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" $PROD_URL/api/health || echo "000")
          
          if [[ "$STATUS" != "200" ]]; then
            echo "âŒ Production health check failed after switch!"
            exit 1
          fi
          
          echo "âœ… Traffic switch successful"

  verify-production:
    name: Verify Production Deployment
    runs-on: ubuntu-latest
    needs: switch-traffic
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run production verification tests
        env:
          BASE_URL: ${{ secrets.PRODUCTION_URL || 'https://goumuve.com' }}
        run: |
          cd e2e
          npm ci || npm install playwright @playwright/test
          npx playwright test smoke --project=chromium
        timeout-minutes: 10
      
      - name: Monitor error rates
        run: |
          echo "ðŸ“Š Monitoring production for 5 minutes..."
          
          PROD_URL="${{ secrets.PRODUCTION_URL || 'https://goumuve.com' }}"
          ERRORS=0
          
          for i in {1..30}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" $PROD_URL/api/health || echo "000")
            
            if [[ "$STATUS" != "200" ]]; then
              ((ERRORS++))
            fi
            
            sleep 10
          done
          
          ERROR_RATE=$((ERRORS * 100 / 30))
          echo "Error rate: $ERROR_RATE%"
          
          if [[ $ERROR_RATE -gt 10 ]]; then
            echo "âŒ Error rate too high: $ERROR_RATE%"
            echo "SHOULD_ROLLBACK=true" >> $GITHUB_ENV
            exit 1
          fi
          
          echo "âœ… Production is stable"

  rollback:
    name: Automatic Rollback
    runs-on: ubuntu-latest
    needs: [switch-traffic, verify-production]
    if: failure()
    
    steps:
      - name: Rollback to Green environment
        run: |
          echo "ðŸ”´ INITIATING AUTOMATIC ROLLBACK"
          
          # Switch traffic back to Green
          aws elbv2 modify-listener \
            --listener-arn ${{ secrets.PRODUCTION_LISTENER_ARN }} \
            --default-actions Type=forward,TargetGroupArn=${{ secrets.GREEN_TARGET_GROUP_ARN }} \
            --region ${{ secrets.AWS_REGION || 'us-east-1' }}
          
          echo "âœ… Traffic rolled back to Green (previous stable version)"
      
      - name: Rollback database migrations
        if: ${{ env.ROLLBACK_VERSION != '' }}
        run: |
          echo "ðŸ“Š Rolling back database migrations to version: $ROLLBACK_VERSION"
          # This would run database downgrade command
          # Requires careful implementation based on your migration strategy
      
      - name: Verify rollback successful
        run: |
          PROD_URL="${{ secrets.PRODUCTION_URL || 'https://goumuve.com' }}"
          
          sleep 30
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" $PROD_URL/api/health || echo "000")
          
          if [[ "$STATUS" == "200" ]]; then
            echo "âœ… Rollback successful - production is healthy"
          else
            echo "âŒ CRITICAL: Rollback failed - manual intervention required!"
            exit 1
          fi

  cleanup-green:
    name: Update Green with New Version
    runs-on: ubuntu-latest
    needs: verify-production
    if: success()
    
    steps:
      - name: Update Green environment to match Blue
        run: |
          echo "â™»ï¸  Updating Green environment to new version for next deployment..."
          
          # Deploy new version to Green (which is now idle)
          aws ecs update-service \
            --cluster umuve-production \
            --service backend-green \
            --force-new-deployment \
            --region ${{ secrets.AWS_REGION || 'us-east-1' }}
          
          aws ecs update-service \
            --cluster umuve-production \
            --service frontend-green \
            --force-new-deployment \
            --region ${{ secrets.AWS_REGION || 'us-east-1' }}
          
          aws ecs update-service \
            --cluster umuve-production \
            --service dashboard-green \
            --force-new-deployment \
            --region ${{ secrets.AWS_REGION || 'us-east-1' }}
          
          echo "âœ… Green environment updated"

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, manual-approval, build-and-push, deploy-blue, smoke-test-blue, switch-traffic, verify-production, rollback]
    if: always()
    
    steps:
      - name: Determine deployment status
        id: status
        run: |
          if [[ "${{ needs.rollback.result }}" == "success" ]]; then
            echo "status=rolled_back" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ”´" >> $GITHUB_OUTPUT
            echo "color=15158332" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.verify-production.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "color=3066993" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "color=15158332" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Discord notification
        if: ${{ secrets.DISCORD_WEBHOOK != '' }}
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          embed-title: "${{ steps.status.outputs.emoji }} Production Deployment"
          embed-description: |
            **Status:** ${{ steps.status.outputs.status }}
            **Branch:** `${{ github.ref_name }}`
            **Commit:** [${{ github.sha }}](${{ github.event.head_commit.url }})
            **Deployed by:** ${{ github.actor }}
            
            **Pre-checks:** ${{ needs.pre-deployment-checks.result == 'success' && 'âœ…' || 'âŒ' }}
            **Approval:** ${{ needs.manual-approval.result == 'success' && 'âœ…' || 'â­ï¸ Skipped' }}
            **Build:** ${{ needs.build-and-push.result == 'success' && 'âœ…' || 'âŒ' }}
            **Blue Deploy:** ${{ needs.deploy-blue.result == 'success' && 'âœ…' || 'âŒ' }}
            **Traffic Switch:** ${{ needs.switch-traffic.result == 'success' && 'âœ…' || 'âŒ' }}
            **Verification:** ${{ needs.verify-production.result == 'success' && 'âœ…' || 'âŒ' }}
            ${{ needs.rollback.result == 'success' && '**ðŸ”´ ROLLED BACK**' || '' }}
          embed-color: ${{ steps.status.outputs.color }}
          embed-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      
      - name: Send Slack notification
        if: ${{ secrets.SLACK_WEBHOOK != '' }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "${{ steps.status.outputs.emoji }} Production Deployment ${{ steps.status.outputs.status }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.status.outputs.emoji }} Production Deployment"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Status:*\n${{ steps.status.outputs.status }}"},
                    {"type": "mrkdwn", "text": "*Deployed by:*\n${{ github.actor }}"},
                    {"type": "mrkdwn", "text": "*Commit:*\n`${{ github.sha }}`"},
                    {"type": "mrkdwn", "text": "*Branch:*\n`${{ github.ref_name }}`"}
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, manual-approval, build-and-push, deploy-blue, smoke-test-blue, switch-traffic, verify-production, rollback, cleanup-green]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸš€ Production Deployment Summary
          
          ## Deployment Status
          ${{ needs.rollback.result == 'success' && 'ðŸ”´ **DEPLOYMENT ROLLED BACK**' || needs.verify-production.result == 'success' && 'âœ… **DEPLOYMENT SUCCESSFUL**' || 'âŒ **DEPLOYMENT FAILED**' }}
          
          ## Pipeline Stages
          - **Pre-deployment Checks:** ${{ needs.pre-deployment-checks.result == 'success' && 'âœ…' || 'âŒ' }}
          - **Manual Approval:** ${{ needs.manual-approval.result == 'success' && 'âœ…' || 'â­ï¸ Skipped' }}
          - **Build Images:** ${{ needs.build-and-push.result == 'success' && 'âœ…' || 'âŒ' }}
          - **Deploy Blue:** ${{ needs.deploy-blue.result == 'success' && 'âœ…' || 'âŒ' }}
          - **Smoke Tests:** ${{ needs.smoke-test-blue.result == 'success' && 'âœ…' || 'âŒ' }}
          - **Traffic Switch:** ${{ needs.switch-traffic.result == 'success' && 'âœ…' || 'âŒ' }}
          - **Verification:** ${{ needs.verify-production.result == 'success' && 'âœ…' || 'âŒ' }}
          - **Cleanup:** ${{ needs.cleanup-green.result == 'success' && 'âœ…' || 'â­ï¸ Skipped' }}
          
          ## Environment Details
          - **Production URL:** ${{ secrets.PRODUCTION_URL || 'https://goumuve.com' }}
          - **Deployment Method:** Blue-Green
          - **Version:** `prod-${{ github.run_number }}`
          - **Commit:** `${{ github.sha }}`
          
          ---
          *Deployed by @${{ github.actor }} at ${{ github.event.head_commit.timestamp }}*
          EOF
