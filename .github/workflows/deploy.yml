# =============================================================================
# Umuve Deploy
# =============================================================================
# Required GitHub Secrets:
#   VERCEL_TOKEN        - Vercel API token for platform deployment
#   VERCEL_ORG_ID       - Vercel organization/team ID
#   VERCEL_PROJECT_ID   - Vercel project ID for the platform app
#
# Optional Secrets:
#   RENDER_API_KEY      - Render API key (for deploy status check)
#   RENDER_SERVICE_ID   - Render service ID for the backend
#   DISCORD_WEBHOOK     - Discord webhook URL for notifications
#   SLACK_WEBHOOK       - Slack webhook URL for notifications
#
# Notes:
#   - Platform (Next.js) deploys to Vercel
#   - Backend (Flask) auto-deploys on Render via git push (status check only)
# =============================================================================

name: Deploy

on:
  push:
    branches: [main]

# Only allow one deploy at a time; cancel older runs
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # -------------------------------------------------------------------
  # Deploy platform to Vercel
  # -------------------------------------------------------------------
  deploy-platform:
    name: Deploy Platform to Vercel
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: platform/package-lock.json

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Pull Vercel environment
        working-directory: platform
        run: |
          vercel pull --yes --environment=production \
            --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build with Vercel
        working-directory: platform
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel (production)
        working-directory: platform
        run: |
          DEPLOY_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV
          echo "Deployed to: $DEPLOY_URL"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Verify deployment health
        run: |
          sleep 15
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL" || echo "000")
          echo "Platform responded with HTTP $STATUS"
          if [[ "$STATUS" -ge 200 && "$STATUS" -lt 400 ]]; then
            echo "Platform deployment is healthy."
          else
            echo "::warning::Platform returned HTTP $STATUS -- verify manually."
          fi

  # -------------------------------------------------------------------
  # Check that Render auto-deploy is healthy
  # -------------------------------------------------------------------
  check-backend:
    name: Verify Backend (Render)
    runs-on: ubuntu-latest

    steps:
      - name: Wait for Render deploy to propagate
        run: |
          echo "Render auto-deploys on git push to main."
          echo "Waiting 90 seconds for the deploy to start and propagate..."
          sleep 90

      - name: Health-check backend
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL || 'https://umuve-backend.onrender.com' }}"
          echo "Checking $BACKEND_URL/api/health ..."

          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/api/health" || echo "000")
            echo "  Attempt $i: HTTP $STATUS"

            if [[ "$STATUS" == "200" ]]; then
              echo "Backend is healthy."
              exit 0
            fi

            sleep 20
          done

          echo "::warning::Backend health check did not return 200 after 5 attempts."
          echo "Render may still be deploying -- check https://dashboard.render.com manually."
          # Do not fail the workflow; Render cold-starts can be slow
          exit 0

  # -------------------------------------------------------------------
  # Optional: Trigger Render deploy via API (if auto-deploy is off)
  # -------------------------------------------------------------------
  trigger-render-deploy:
    name: Trigger Render Deploy (if API key set)
    runs-on: ubuntu-latest
    if: ${{ vars.RENDER_AUTO_DEPLOY != 'true' }}

    steps:
      - name: Trigger deploy hook
        if: ${{ secrets.RENDER_API_KEY != '' && secrets.RENDER_SERVICE_ID != '' }}
        run: |
          curl -s -X POST \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": "do_not_clear"}' \
            && echo "Render deploy triggered." \
            || echo "::warning::Failed to trigger Render deploy via API."

  # -------------------------------------------------------------------
  # Post-deploy notification
  # -------------------------------------------------------------------
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-platform, check-backend]
    if: always()

    steps:
      - name: Post deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY'
          ## Deploy Summary

          | Service  | Target   | Status |
          |----------|----------|--------|
          | Platform | Vercel   | ${{ needs.deploy-platform.result }} |
          | Backend  | Render   | ${{ needs.check-backend.result }} |

          **Commit:** `${{ github.sha }}`
          **Pushed by:** @${{ github.actor }}
          SUMMARY

      - name: Send Discord notification
        if: ${{ secrets.DISCORD_WEBHOOK != '' }}
        uses: tsickert/discord-webhook@v6.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          embed-title: "Deploy to Production"
          embed-description: |
            **Platform (Vercel):** ${{ needs.deploy-platform.result }}
            **Backend (Render):** ${{ needs.check-backend.result }}
            **Commit:** `${{ github.sha }}`
            **By:** ${{ github.actor }}
          embed-color: ${{ needs.deploy-platform.result == 'success' && needs.check-backend.result == 'success' && '3066993' || '15158332' }}

      - name: Send Slack notification
        if: ${{ secrets.SLACK_WEBHOOK != '' }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "Umuve Deploy: Platform=${{ needs.deploy-platform.result }}, Backend=${{ needs.check-backend.result }} (commit ${{ github.sha }})"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
