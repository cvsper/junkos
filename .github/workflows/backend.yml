# =============================================================================
# Umuve Backend CI
# =============================================================================
# Required GitHub Secrets:
#   (none required for CI -- tests run against local SQLite/Postgres service)
#
# Optional Secrets:
#   CODECOV_TOKEN  - Upload coverage to Codecov
# =============================================================================

name: Backend Tests

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'

env:
  PYTHON_VERSION: '3.11'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements*.txt

      - name: Install flake8
        run: pip install flake8

      - name: Run flake8
        working-directory: backend
        run: |
          flake8 . \
            --max-line-length=120 \
            --ignore=E501,W503 \
            --exclude=venv,__pycache__,migrations,umuve.db,uploads

  import-check:
    name: Import Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements*.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify all route modules import cleanly
        working-directory: backend
        env:
          DATABASE_URL: ""
          FLASK_ENV: testing
          SECRET_KEY: ci-test-secret-key
        run: |
          python -c "
          import importlib, sys, os

          os.environ.setdefault('SECRET_KEY', 'ci-test-secret-key')

          # Top-level modules that must import without error
          modules = [
              'server',
              'models',
              'database',
              'extensions',
              'app_config',
              'auth_routes',
              'sanitize',
              'socket_events',
              'notifications',
              'email_templates',
              'geofencing',
              'push_notifications',
          ]

          # Route sub-modules
          route_modules = [
              'routes',
              'routes.admin',
              'routes.booking',
              'routes.driver',
              'routes.drivers',
              'routes.jobs',
              'routes.operator',
              'routes.payments',
              'routes.pricing',
              'routes.push',
              'routes.ratings',
              'routes.recurring',
              'routes.referrals',
              'routes.service_area',
              'routes.support',
              'routes.tracking',
              'routes.upload',
          ]

          failed = []
          for mod in modules + route_modules:
              try:
                  importlib.import_module(mod)
                  print(f'  OK  {mod}')
              except Exception as e:
                  print(f'  FAIL  {mod}: {e}')
                  failed.append(mod)

          if failed:
              print(f'\n{len(failed)} module(s) failed to import.')
              sys.exit(1)
          else:
              print(f'\nAll {len(modules) + len(route_modules)} modules imported successfully.')
          "

  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: [lint, import-check]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: umuve_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements*.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Run pytest
        working-directory: backend
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/umuve_test
          FLASK_ENV: testing
          SECRET_KEY: ci-test-secret-key
        run: |
          pytest \
            --cov=. \
            --cov-report=xml \
            --cov-report=term-missing \
            --maxfail=10 \
            -v \
            || echo "::warning::pytest exited with non-zero status -- check output above"

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.xml
          flags: backend
          fail_ci_if_error: false
        continue-on-error: true
