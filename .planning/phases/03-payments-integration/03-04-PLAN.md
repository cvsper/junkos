---
phase: 03-payments-integration
plan: 04
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - JunkOS-Driver/ViewModels/EarningsViewModel.swift
  - JunkOS-Driver/Models/EarningsModels.swift
  - JunkOS-Driver/Views/Earnings/EarningsView.swift
  - JunkOS-Driver/Services/DriverAPIClient.swift
autonomous: true

must_haves:
  truths:
    - "Driver sees earnings summary with totals for today, this week, this month, and all time"
    - "Driver sees per-job earnings list with address, amount (80% take), date, and payout status"
    - "Each job shows payout status badge: Pending, Processing, or Paid"
    - "Earnings amounts are driver's 80% take only (not full job price)"
    - "Date range filter switches between today, this week, this month, and all time"
  artifacts:
    - path: "JunkOS-Driver/ViewModels/EarningsViewModel.swift"
      provides: "API-driven earnings fetching with period filtering"
      contains: "fetchEarnings"
    - path: "JunkOS-Driver/Models/EarningsModels.swift"
      provides: "Updated EarningsSummary with allTimeEarnings, EarningsEntry with payoutStatus"
      contains: "payoutStatus"
    - path: "JunkOS-Driver/Views/Earnings/EarningsView.swift"
      provides: "Earnings dashboard with payout status badges and All Time filter"
      contains: "payoutStatusBadge"
    - path: "JunkOS-Driver/Services/DriverAPIClient.swift"
      provides: "getEarnings and getEarningsHistory API methods"
      contains: "getEarningsHistory"
  key_links:
    - from: "EarningsViewModel.swift"
      to: "DriverAPIClient.swift"
      via: "fetchEarnings() calls getEarningsHistory()"
      pattern: "getEarningsHistory"
    - from: "EarningsView.swift"
      to: "EarningsViewModel.swift"
      via: "viewModel.entries and viewModel.summary drive UI"
      pattern: "viewModel.entries|viewModel.summary"
    - from: "EarningsViewModel.swift"
      to: "EarningsModels.swift"
      via: "Maps API response to EarningsSummary and EarningsEntry"
      pattern: "EarningsSummary|EarningsEntry"
---

<objective>
Connect the driver earnings dashboard to the backend API with per-job payout status tracking and date range filters including "All Time".

Purpose: Drivers need to see their actual earnings from the backend (not empty stubs). This implements PAY-05 — driver earnings summary with today/week/month/all-time filters and per-job detail showing payout status (Pending/Processing/Paid). Amounts show driver's 80% take only.

Output: API-connected EarningsView with summary cards, per-job list with payout status badges, and date range filters.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-payments-integration/03-RESEARCH.md
@.planning/phases/03-payments-integration/03-02-SUMMARY.md
@JunkOS-Driver/ViewModels/EarningsViewModel.swift
@JunkOS-Driver/Models/EarningsModels.swift
@JunkOS-Driver/Views/Earnings/EarningsView.swift
@JunkOS-Driver/Services/DriverAPIClient.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update models and ViewModel with API integration</name>
  <files>
    JunkOS-Driver/Models/EarningsModels.swift
    JunkOS-Driver/ViewModels/EarningsViewModel.swift
    JunkOS-Driver/Services/DriverAPIClient.swift
  </files>
  <action>
**1. DriverAPIClient.swift — Add earnings API method:**

Add response model:
```swift
struct EarningsHistoryResponse: Codable {
    let success: Bool
    let entries: [EarningsEntryResponse]
    let summary: EarningsSummaryResponse

    struct EarningsEntryResponse: Codable {
        let id: String
        let jobId: String
        let address: String
        let amount: Double      // driver_payout_amount (80% take)
        let date: String?       // ISO 8601 date string
        let payoutStatus: String // "pending", "processing", "paid"

        enum CodingKeys: String, CodingKey {
            case id
            case jobId = "job_id"
            case address
            case amount
            case date
            case payoutStatus = "payout_status"
        }
    }

    struct EarningsSummaryResponse: Codable {
        let today: Double
        let week: Double
        let month: Double
        let allTime: Double

        enum CodingKeys: String, CodingKey {
            case today
            case week
            case month
            case allTime = "all_time"
        }
    }
}
```

Add method:
```swift
func getEarningsHistory() async throws -> EarningsHistoryResponse {
    try await request("/api/payments/earnings/history")
}
```

**2. EarningsModels.swift — Update with payout status and all-time:**

Update `EarningsSummary`:
- Add `allTimeEarnings: Double` property
- Add `formattedAllTime: String` computed property
- Update `empty` static to include `allTimeEarnings: 0`

Update `EarningsEntry`:
- Change `status: String` to `payoutStatus: PayoutStatus`
- Add enum:
```swift
enum PayoutStatus: String {
    case pending = "pending"
    case processing = "processing"
    case paid = "paid"

    var displayName: String {
        switch self {
        case .pending: return "Pending"
        case .processing: return "Processing"
        case .paid: return "Paid"
        }
    }

    var color: String {  // Use string for Color lookup
        switch self {
        case .pending: return "driverWarning"
        case .processing: return "driverPrimary"
        case .paid: return "driverSuccess"
        }
    }
}
```

**3. EarningsViewModel.swift — Add API integration:**

The existing EarningsViewModel is `@Observable` with stub data. Enhance it:

- Add `"All Time"` case to `EarningsPeriod` enum (locked decision: full earnings history with date range filters including all-time)
- Add `var errorMessage: String?`
- Add `func fetchEarnings() async`:
  - Set `isLoading = true`
  - Call `DriverAPIClient.shared.getEarningsHistory()`
  - Map response.summary to `EarningsSummary` (today, week, month, allTime)
  - Map response.entries to `[EarningsEntry]` array:
    - Parse ISO date string to Date
    - Map payout_status string to PayoutStatus enum
    - Use `amount` directly (already driver's 80% take from backend)
  - On error: set `errorMessage`, keep existing data
  - Set `isLoading = false`
- Update `displayedAmount` to handle `.all` case (returns `summary.formattedAllTime`)
- Add computed `filteredEntries: [EarningsEntry]` that filters entries by selected period:
  - `.today`: entries from today
  - `.week`: entries from last 7 days
  - `.month`: entries from last 30 days
  - `.all`: all entries (no filter)

**Do NOT:**
- Show full job price (only driver_payout_amount from API)
- Multiply by 0.8 client-side (backend already returns correct amount)
- Paginate (unpaginated for MVP per research recommendation)
  </action>
  <verify>
Read all three files and verify:
1. EarningsModels has PayoutStatus enum and allTimeEarnings
2. EarningsViewModel has fetchEarnings() async calling DriverAPIClient
3. DriverAPIClient has getEarningsHistory() method
4. Amount field maps to driver_payout_amount (no client-side multiplication)
5. EarningsPeriod has "All Time" case
  </verify>
  <done>
EarningsViewModel fetches real data from backend API. Models include payout status enum and all-time earnings. DriverAPIClient has earnings history method. All amounts are driver's 80% take from backend.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update EarningsView with payout status badges and loading state</name>
  <files>
    JunkOS-Driver/Views/Earnings/EarningsView.swift
  </files>
  <action>
**Update EarningsView to show API-driven data with payout status badges:**

1. **Add `.task` modifier** to load data on appear:
   ```swift
   .task { await viewModel.fetchEarnings() }
   ```
   Also add `.refreshable { await viewModel.fetchEarnings() }` for pull-to-refresh

2. **Add loading state:**
   - When `viewModel.isLoading` and entries are empty, show centered ProgressView with "Loading earnings..." text
   - When loading with existing data, show subtle refresh indicator

3. **Update period picker** — Add "All Time" option (now 4 segments: Today, This Week, This Month, All Time)
   - Use `viewModel.filteredEntries` instead of `viewModel.entries` for the list

4. **Update summary card:**
   - Show the amount from `viewModel.displayedAmount` (already handles period switching)
   - Add small job count below if available: "X jobs" in caption style

5. **Update EarningsRow** to show payout status badge:
   - Add a payout status badge to the right side of each row (below/beside the amount):
   ```swift
   Text(entry.payoutStatus.displayName)
       .font(DriverTypography.caption2)
       .foregroundStyle(payoutStatusColor(entry.payoutStatus))
       .padding(.horizontal, 6)
       .padding(.vertical, 2)
       .background(payoutStatusColor(entry.payoutStatus).opacity(0.1))
       .clipShape(RoundedRectangle(cornerRadius: 4))
   ```
   - Status colors:
     - Pending: driverWarning (amber/yellow)
     - Processing: driverPrimary (blue/red depending on driver design)
     - Paid: driverSuccess (green)

6. **Error handling:**
   - If `viewModel.errorMessage` is set, show error banner at top (red background, white text, retry button)
   - Banner dismissible with tap

7. **Empty state:** Keep existing EmptyStateView but update message: "Complete jobs to start earning. Your earnings history will appear here."

**Layout for each EarningsRow (updated):**
```
| [Address text]                    [$XX.XX] |
| [Date text]              [Paid ✓] badge    |
```

The address and date are left-aligned, amount is right-aligned, and payout status badge is below the amount, also right-aligned.

**Do NOT:**
- Show commission or full price anywhere
- Add custom date picker for now (just the 4 segmented options per locked decision: today, this week, this month, all time — "custom" was mentioned in context but the 4 segments cover the requirement)
  </action>
  <verify>
Read EarningsView.swift and verify:
1. `.task` modifier calls fetchEarnings
2. Pull-to-refresh with `.refreshable`
3. Loading state shown when isLoading
4. 4 period segments including "All Time"
5. EarningsRow shows payout status badge with color
6. Error handling with banner
7. Uses filteredEntries for period filtering
  </verify>
  <done>
EarningsView is API-connected with pull-to-refresh, loading states, 4 date range filters (today/week/month/all-time), per-job payout status badges (Pending/Processing/Paid), and error handling. All amounts show driver's 80% take only.
  </done>
</task>

</tasks>

<verification>
1. EarningsView loads data from backend on appear
2. Pull-to-refresh triggers API call
3. Period filter has 4 options including "All Time"
4. Each job row shows payout status badge with appropriate color
5. Amounts are driver's 80% take (from backend, not calculated client-side)
6. Loading and error states handled gracefully
7. Empty state shown when no earnings
</verification>

<success_criteria>
- Driver opens Earnings tab and sees real data from API
- Switching period filter updates displayed total and filtered job list
- Each job row shows: address, amount (driver's take), date, payout status badge
- Payout status uses correct colors: Pending (amber), Processing (blue), Paid (green)
- Pull-to-refresh works to reload data
- Loading spinner shown during initial load
</success_criteria>

<output>
After completion, create `.planning/phases/03-payments-integration/03-04-SUMMARY.md`
</output>
