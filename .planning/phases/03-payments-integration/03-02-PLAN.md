---
phase: 03-payments-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/routes/payments.py
  - backend/routes/drivers.py
autonomous: true

must_haves:
  truths:
    - "Backend creates Stripe Connect account for driver and returns onboarding URL"
    - "Backend returns driver's Stripe Connect onboarding status (not set up / pending / active)"
    - "Backend returns detailed earnings history with per-job payout status"
    - "Webhook handles account.updated event to track Connect verification status"
    - "Earnings history returns driver_payout_amount (80% take), not full job price"
  artifacts:
    - path: "backend/routes/payments.py"
      provides: "Stripe Connect account creation, account link generation, account status, earnings history, account.updated webhook"
      contains: "account_links"
    - path: "backend/routes/drivers.py"
      provides: "Connect onboarding status endpoint on driver profile"
      contains: "stripe_connect"
  key_links:
    - from: "POST /api/payments/connect/create-account"
      to: "Stripe API"
      via: "stripe.Account.create(type='express')"
      pattern: "Account.create"
    - from: "POST /api/payments/connect/account-link"
      to: "Stripe API"
      via: "stripe.AccountLink.create()"
      pattern: "AccountLink.create"
    - from: "GET /api/payments/earnings/history"
      to: "Payment model"
      via: "query driver_payout_amount from payments joined with jobs"
      pattern: "driver_payout_amount"
    - from: "webhook /api/webhooks/stripe"
      to: "Contractor model"
      via: "account.updated updates charges_enabled on contractor"
      pattern: "account.updated"
---

<objective>
Add backend endpoints for Stripe Connect onboarding (account creation, account links, status) and detailed earnings history with payout status per job.

Purpose: The driver app needs backend support for mandatory Stripe Connect setup and API-driven earnings dashboard. These endpoints serve both the Connect onboarding flow (Plan 03-03) and the earnings dashboard (Plan 03-04). Also enhances webhook handler for Connect account status tracking.

Output: New API endpoints for Connect account management, earnings history, and enhanced webhook handler.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-payments-integration/03-RESEARCH.md
@backend/routes/payments.py
@backend/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Stripe Connect endpoints and earnings history</name>
  <files>
    backend/routes/payments.py
  </files>
  <action>
Add these new endpoints to `payments.py` (after existing endpoints, before webhook section):

**1. POST /api/payments/connect/create-account**
- `@require_auth` — authenticated driver only
- Look up Contractor by user_id
- If contractor already has `stripe_connect_id`, return it (idempotent)
- Otherwise: call `stripe.Account.create(type="express", country="US", capabilities={"card_payments": {"requested": True}, "transfers": {"requested": True}})` (skip if no STRIPE_SECRET_KEY, generate mock ID `acct_dev_{uuid[:8]}`)
- Save `stripe_connect_id` on contractor, commit
- Return `{ success: true, account_id: ... }`

**2. POST /api/payments/connect/account-link**
- `@require_auth` — authenticated driver only
- Look up Contractor, verify they have `stripe_connect_id` (400 if not)
- Call `stripe.AccountLink.create(account=contractor.stripe_connect_id, refresh_url="{baseURL}/api/payments/connect/refresh", return_url="{baseURL}/api/payments/connect/return", type="account_onboarding")` where baseURL comes from env var `APP_BASE_URL` or defaults to `http://localhost:8080`
- For dev mode (no STRIPE_SECRET_KEY): return mock URL `https://connect.stripe.com/setup/e/mock`
- Return `{ success: true, url: accountLink.url, expires_at: accountLink.expires_at }`
- **IMPORTANT:** Generate fresh link each time (never cache — links expire in 5 minutes)

**3. GET /api/payments/connect/status**
- `@require_auth` — authenticated driver only
- Look up Contractor
- If no `stripe_connect_id`: return `{ status: "not_set_up", charges_enabled: false, payouts_enabled: false }`
- If has `stripe_connect_id`: call `stripe.Account.retrieve(contractor.stripe_connect_id)` (skip if no key, return stored values)
- Return `{ success: true, status: "active"|"pending_verification"|"not_set_up", charges_enabled: bool, payouts_enabled: bool, details_submitted: bool }`
- Determine status: `charges_enabled && payouts_enabled` = "active", `stripe_connect_id` exists but not fully enabled = "pending_verification", no ID = "not_set_up"

**4. GET /api/payments/connect/return** and **GET /api/payments/connect/refresh**
- Simple redirect endpoints that Stripe calls after onboarding
- `/return`: Return HTML page saying "Setup complete. Return to the Umuve Pro app." (or redirect to deep link `umuvepro://stripe-return`)
- `/refresh`: Redirect to a page saying "Link expired. Please return to the app and try again." (or redirect to `umuvepro://stripe-refresh`)

**5. GET /api/payments/earnings/history**
- `@require_auth` — authenticated driver only
- Look up Contractor by user_id
- Query all Payments joined with Jobs where `Job.driver_id == contractor.id` AND `Payment.payment_status == "succeeded"`
- Order by `Payment.created_at DESC`
- For each payment, return: `{ id, job_id, address (from job), amount: payment.driver_payout_amount, date: payment.created_at ISO, payout_status: payment.payout_status }`
- **CRITICAL:** Return `driver_payout_amount` only, NOT `payment.amount` (locked decision: show driver's 80% take only)
- Also compute summary: `today_earnings`, `week_earnings` (7d), `month_earnings` (30d), `all_time_earnings`
- Return `{ success: true, entries: [...], summary: { today: ..., week: ..., month: ..., all_time: ... } }`

**Also update existing webhook handler** in `stripe_webhook()`:
- Add `account.updated` event type handling
- Create `_handle_account_updated(account)` function:
  - Extract `account["id"]` (Stripe Connect account ID)
  - Find Contractor by `stripe_connect_id == account["id"]`
  - If found, check `account.get("charges_enabled")` and `account.get("payouts_enabled")`
  - No model changes needed (status derived from Stripe API calls) — but log the event for debugging
  - Optional: store `charges_enabled` flag on contractor if you want to avoid API calls on every status check

**Do NOT:**
- Expose full job price in earnings history (only driver_payout_amount)
- Cache account links (generate fresh each time)
- Skip webhook signature verification
  </action>
  <verify>
```bash
cd /Users/sevs/Documents/Programs/webapps/junkos/backend && python3 -c "from routes.payments import payments_bp, webhook_bp; print('Payments routes import OK')"
```
Also read the file and verify:
1. All 5 new endpoints exist with correct URL paths
2. Earnings history returns `driver_payout_amount` not `amount`
3. account.updated handler exists in webhook
4. Account link is generated fresh (no caching)
  </verify>
  <done>
Backend has Stripe Connect account creation, account link generation, status check, return/refresh redirects, and detailed earnings history endpoints. Webhook handles account.updated. Earnings return driver's 80% take only.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Stripe Connect status to driver profile endpoint</name>
  <files>
    backend/routes/drivers.py
  </files>
  <action>
**Verify existing `/api/drivers/profile` endpoint** already returns `stripe_connect_id` via `contractor.to_dict()`.

If `to_dict()` already includes `stripe_connect_id`, no changes needed to drivers.py.

If NOT included, add `stripe_connect_id` to the profile response.

**Also check:** The Contractor model's `to_dict()` in `models.py` — verify it includes `stripe_connect_id`. If not, this is the field to add.

Read `backend/models.py` to find the Contractor `to_dict()` method and verify `stripe_connect_id` is included. If missing, add it.

**Key verification:** The driver app's `ContractorProfile` Swift struct already has `stripeConnectId` mapped to `stripe_connect_id` (confirmed in ContractorModels.swift). So the backend just needs to return this field.
  </action>
  <verify>
```bash
cd /Users/sevs/Documents/Programs/webapps/junkos/backend && python3 -c "
from models import Contractor
c = Contractor.__table__.columns
print('stripe_connect_id column exists:', 'stripe_connect_id' in [col.name for col in c])
"
```
  </verify>
  <done>
Driver profile endpoint returns `stripe_connect_id` field, enabling the driver app to check Connect onboarding status from the existing profile response.
  </done>
</task>

</tasks>

<verification>
1. `python3 -c "from routes.payments import payments_bp, webhook_bp"` succeeds
2. POST /api/payments/connect/create-account creates Express account
3. POST /api/payments/connect/account-link returns fresh URL
4. GET /api/payments/connect/status returns onboarding status
5. GET /api/payments/earnings/history returns entries with driver_payout_amount
6. Webhook handles account.updated event
7. Driver profile includes stripe_connect_id
</verification>

<success_criteria>
- All new endpoints importable without errors
- Earnings history returns driver_payout_amount (not full price)
- Account link generated fresh each time (never cached)
- Connect status derived from Stripe API or stored flags
- Webhook processes account.updated events
</success_criteria>

<output>
After completion, create `.planning/phases/03-payments-integration/03-02-SUMMARY.md`
</output>
