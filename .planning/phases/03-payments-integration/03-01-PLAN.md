---
phase: 03-payments-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - JunkOS-Clean/JunkOS/Services/PaymentService.swift
  - JunkOS-Clean/JunkOS/Services/Config.swift
  - JunkOS-Clean/JunkOS/ViewModels/BookingReviewViewModel.swift
  - JunkOS-Clean/JunkOS/Views/BookingReviewView.swift
autonomous: false
user_setup:
  - service: stripe-ios-sdk
    why: "Stripe Payment Sheet requires StripePaymentSheet SPM package"
    dashboard_config:
      - task: "Add Swift Package: https://github.com/stripe/stripe-ios (select StripePaymentSheet product, add to JunkOS target)"
        location: "Xcode -> File -> Add Package Dependencies"
      - task: "Add Apple Pay Payment Processing capability to JunkOS target"
        location: "Xcode -> JunkOS target -> Signing & Capabilities -> + Capability -> Apple Pay Payment Processing -> add merchant.com.goumuve.app"
  - service: stripe-dashboard
    why: "Stripe publishable key needed for Payment Sheet"
    env_vars:
      - name: STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key (pk_test_... or pk_live_...)"
    dashboard_config:
      - task: "Verify Apple Pay merchant ID is configured"
        location: "Stripe Dashboard -> Settings -> Apple Pay -> Verify merchant.com.goumuve.app exists"

must_haves:
  truths:
    - "Customer sees price breakdown on review screen before tapping Pay"
    - "Tapping 'Confirm & Pay' presents Stripe Payment Sheet with Apple Pay and card entry"
    - "Successful payment creates the job (no job without payment)"
    - "Canceled payment returns to review screen without creating a job"
    - "Failed payment shows user-friendly error message"
  artifacts:
    - path: "JunkOS-Clean/JunkOS/Services/PaymentService.swift"
      provides: "Payment Sheet configuration and PaymentIntent creation"
      contains: "PaymentSheet"
    - path: "JunkOS-Clean/JunkOS/ViewModels/BookingReviewViewModel.swift"
      provides: "Payment flow orchestration (prepare sheet -> present -> handle result -> create job)"
      contains: "paymentSheet"
    - path: "JunkOS-Clean/JunkOS/Views/BookingReviewView.swift"
      provides: "Payment Sheet presentation via .paymentSheet modifier"
      contains: "paymentSheet"
    - path: "JunkOS-Clean/JunkOS/Services/Config.swift"
      provides: "Stripe publishable key configuration"
      contains: "stripePublishableKey"
  key_links:
    - from: "BookingReviewView.swift"
      to: "BookingReviewViewModel.swift"
      via: "confirmAndPay() triggers PaymentSheet preparation"
      pattern: "confirmAndPay|preparePaymentSheet"
    - from: "BookingReviewViewModel.swift"
      to: "PaymentService.swift"
      via: "createPaymentIntent() call to get clientSecret"
      pattern: "createPaymentIntent"
    - from: "BookingReviewViewModel.swift"
      to: "APIClient.swift"
      via: "createJob() only called after PaymentSheetResult.completed"
      pattern: "createJob.*after.*payment|PaymentSheetResult.completed"
---

<objective>
Integrate Stripe Payment Sheet into the customer booking flow so payment happens before job creation.

Purpose: Customer pays upfront via Stripe's native Payment Sheet (Apple Pay + card entry) as the final action in the booking wizard. No job is created without successful payment. This is the core customer-side payment requirement (PAY-01, PAY-02).

Output: Modified BookingReviewView presents Stripe Payment Sheet after user confirms booking details. Payment → job creation flow enforced. Success overlay updated with payment confirmation.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-payments-integration/03-RESEARCH.md
@.planning/phases/02-pricing-booking/02-05-SUMMARY.md
@JunkOS-Clean/JunkOS/Services/PaymentService.swift
@JunkOS-Clean/JunkOS/Services/Config.swift
@JunkOS-Clean/JunkOS/ViewModels/BookingReviewViewModel.swift
@JunkOS-Clean/JunkOS/Views/BookingReviewView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Stripe Payment Sheet support to PaymentService and Config</name>
  <files>
    JunkOS-Clean/JunkOS/Services/PaymentService.swift
    JunkOS-Clean/JunkOS/Services/Config.swift
  </files>
  <action>
**Config.swift changes:**
Add `stripePublishableKey` to `APIEnvironment` enum and `Config` class:
- Development: `"pk_test_PLACEHOLDER"` (user will replace with real key)
- Production: `"pk_live_PLACEHOLDER"`
- Expose via `Config.shared.stripePublishableKey`

**PaymentService.swift changes:**
1. Add `import StripePaymentSheet` at the top
2. Add a `configureStripe()` static method that sets `STPAPIClient.shared.publishableKey = Config.shared.stripePublishableKey`. Call this once from app startup or lazily on first use.
3. Add method `preparePaymentSheet(amountInDollars:bookingDescription:) async throws -> PaymentSheet`:
   - Calls existing `createPaymentIntent(amountInDollars:)` to get `clientSecret`
   - Configures `PaymentSheet.Configuration()`:
     - `merchantDisplayName = "Umuve"`
     - `applePay = .init(merchantId: "merchant.com.goumuve.app", merchantCountryCode: "US")`
     - `returnURL = "umuve://payment-return"`
     - `allowsDelayedPaymentMethods = false`
   - Returns `PaymentSheet(paymentIntentClientSecret: response.clientSecret, configuration: config)`
4. Add stored property `var paymentIntentId: String?` to track the current intent ID for later confirmation
5. Keep existing `createPaymentIntent` and `confirmPayment` methods intact

**Do NOT:**
- Remove any existing PaymentService methods
- Build custom card form (use Payment Sheet per user decision)
- Save cards for future use (fresh entry each booking per user decision)
  </action>
  <verify>
File compiles: Check for syntax errors by reading the file and verifying import statements, method signatures, and return types are correct. The actual build requires SPM package to be added first (user_setup).
  </verify>
  <done>
PaymentService has `preparePaymentSheet()` method that creates a PaymentIntent via backend and returns a configured PaymentSheet object. Config exposes `stripePublishableKey`. Stripe SDK configured with publishable key.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Payment Sheet into booking review flow</name>
  <files>
    JunkOS-Clean/JunkOS/ViewModels/BookingReviewViewModel.swift
    JunkOS-Clean/JunkOS/Views/BookingReviewView.swift
  </files>
  <action>
**BookingReviewViewModel.swift changes:**
1. Add `import StripePaymentSheet`
2. Add published properties:
   - `@Published var paymentSheet: PaymentSheet?`
   - `@Published var isPreparingPayment = false`
   - `@Published var paymentIntentId: String?`
3. Rename existing `confirmBooking(bookingData:)` to `confirmAndPay(bookingData:)`:
   - Keep existing validation logic (service type, address, date/time)
   - Instead of immediately uploading photos + creating job:
     - Set `isPreparingPayment = true`
     - Call `PaymentService.shared.preparePaymentSheet(amountInDollars: bookingData.estimatedPrice ?? 0)`
     - Store the returned `PaymentSheet` in `self.paymentSheet` (this triggers Payment Sheet presentation in the view)
     - Store `PaymentService.shared.paymentIntentId` in `self.paymentIntentId`
     - Set `isPreparingPayment = false`
   - On error: set `errorMessage`, reset `isPreparingPayment`
4. Add `handlePaymentResult(_ result: PaymentSheetResult, bookingData: BookingData) async`:
   - `.completed`: Call private method `createJobAfterPayment(bookingData:)` which contains the existing photo upload + job creation logic from the old `confirmBooking`. Also call `PaymentService.shared.confirmPayment(paymentIntentId:)` to notify backend. Then set `showSuccess = true`.
   - `.canceled`: Reset state (`paymentSheet = nil`), no error shown (user chose to dismiss)
   - `.failed(let error)`: Set `errorMessage = "Payment failed: \(error.localizedDescription)"`, reset `paymentSheet = nil`
5. Extract existing photo upload + job creation into private `createJobAfterPayment(bookingData:) async`

**BookingReviewView.swift changes:**
1. Add `import StripePaymentSheet`
2. Change "Confirm Booking" button text to "Confirm & Pay"
3. Change button action to call `viewModel.confirmAndPay(bookingData: bookingData)`
4. Show loading state during both `isPreparingPayment` (preparing payment) and `isSubmitting` (creating job)
5. Add `.paymentSheet()` modifier to present Payment Sheet when `viewModel.paymentSheet` is set:
   ```swift
   .paymentSheet(
       isPresented: $showPaymentSheet,
       paymentSheet: viewModel.paymentSheet!,
       onCompletion: { result in
           Task {
               await viewModel.handlePaymentResult(result, bookingData: bookingData)
           }
       }
   )
   ```
   Use a computed binding or @State to derive `showPaymentSheet` from `viewModel.paymentSheet != nil`
6. Update success overlay: Add "Payment confirmed" text with a green creditcard.fill icon badge above the "Booking Confirmed!" text, matching existing overlay pattern
7. Button disabled state: disabled when `isPreparingPayment || isSubmitting`

**Key flow enforced by this design:**
Review → Tap "Confirm & Pay" → PaymentIntent created → Payment Sheet presented → User pays → Payment succeeds → Photos uploaded → Job created → Success overlay

**Do NOT:**
- Create job before payment succeeds (locked decision)
- Show separate payment screen (payment sheet appears from review step per locked decision)
- Save cards (fresh entry each booking per locked decision)
  </action>
  <verify>
Read both files and verify:
1. BookingReviewViewModel has `confirmAndPay`, `handlePaymentResult`, and `createJobAfterPayment` methods
2. BookingReviewView has `.paymentSheet()` modifier and "Confirm & Pay" button text
3. Job creation (createJob call) only happens inside the `.completed` case of handlePaymentResult
4. Success overlay includes payment confirmation indicator
  </verify>
  <done>
BookingReviewView presents Stripe Payment Sheet via "Confirm & Pay" button. Payment must succeed before job creation. Canceled payment returns to review. Failed payment shows error. Success overlay shows payment confirmation. No job exists without successful payment.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Stripe Payment Sheet integration</name>
  <what-built>Stripe Payment Sheet integrated into customer booking wizard. "Confirm & Pay" button on review screen prepares a PaymentIntent and presents Stripe's native Payment Sheet. Job is only created after successful payment.</what-built>
  <action>User verifies the Payment Sheet integration by building and testing the app.</action>
  <how-to-verify>
1. Ensure Stripe iOS SDK is added via SPM (File -> Add Package Dependencies -> https://github.com/stripe/stripe-ios -> StripePaymentSheet product)
2. Ensure Apple Pay capability is added to target
3. Set a real Stripe publishable key in Config.swift (replace PLACEHOLDER)
4. Build and run on simulator
5. Go through booking wizard to Review step
6. Verify price breakdown is visible
7. Tap "Confirm & Pay" — Stripe Payment Sheet should appear
8. Test cancel (dismiss sheet) — should return to review, no job created
9. Test with test card (4242 4242 4242 4242) — should show success overlay with payment confirmation
  </how-to-verify>
  <verify>User confirms Payment Sheet appears and payment flow works end-to-end.</verify>
  <done>Payment Sheet integration verified on device/simulator.</done>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. PaymentService.swift compiles with StripePaymentSheet import and preparePaymentSheet method
2. BookingReviewViewModel orchestrates: validate → create intent → present sheet → handle result → create job
3. BookingReviewView shows "Confirm & Pay" button and presents Payment Sheet
4. Job creation ONLY happens after PaymentSheetResult.completed (not before)
5. Success overlay shows payment confirmation indicator
</verification>

<success_criteria>
- Customer sees price breakdown on review screen before payment
- "Confirm & Pay" triggers Stripe Payment Sheet (Apple Pay + card entry)
- Successful payment results in job creation + success overlay
- Canceled payment returns to review without creating job
- Failed payment shows error message
- No code path creates a job without successful payment
</success_criteria>

<output>
After completion, create `.planning/phases/03-payments-integration/03-01-SUMMARY.md`
</output>
