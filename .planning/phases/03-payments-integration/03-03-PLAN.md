---
phase: 03-payments-integration
plan: 03
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - JunkOS-Driver/Views/Auth/StripeConnectOnboardingView.swift
  - JunkOS-Driver/ViewModels/StripeConnectViewModel.swift
  - JunkOS-Driver/Services/DriverAPIClient.swift
  - JunkOS-Driver/JunkOSDriverApp.swift
  - JunkOS-Driver/Views/Profile/PayoutSettingsView.swift
  - JunkOS-Driver/ViewModels/AppState.swift
autonomous: true

must_haves:
  truths:
    - "Driver sees mandatory Stripe Connect setup screen after sign-in before accessing app"
    - "Tapping 'Connect with Stripe' opens SFSafariViewController with Stripe hosted onboarding"
    - "After completing onboarding in browser, dismissing returns to app and checks status"
    - "Driver with active Connect status bypasses setup screen and accesses main tab view"
    - "Settings shows payout status badge (Not set up / Pending verification / Active) with action button"
    - "Driver is blocked from app until Connect setup is complete"
  artifacts:
    - path: "JunkOS-Driver/Views/Auth/StripeConnectOnboardingView.swift"
      provides: "Mandatory Stripe Connect setup screen with SFSafariViewController"
      contains: "SFSafariViewController"
    - path: "JunkOS-Driver/ViewModels/StripeConnectViewModel.swift"
      provides: "Connect onboarding state management (create account, get link, check status)"
      contains: "StripeConnectViewModel"
    - path: "JunkOS-Driver/JunkOSDriverApp.swift"
      provides: "App entry point gates driver behind Connect setup"
      contains: "StripeConnectOnboardingView"
    - path: "JunkOS-Driver/Views/Profile/PayoutSettingsView.swift"
      provides: "Payout status badge and onboarding link in settings"
      contains: "onboardingStatus"
    - path: "JunkOS-Driver/Services/DriverAPIClient.swift"
      provides: "API methods for Connect account creation, link, and status"
      contains: "createConnectAccount"
  key_links:
    - from: "JunkOSDriverApp.swift"
      to: "StripeConnectOnboardingView.swift"
      via: "Conditional rendering when Connect not complete"
      pattern: "hasCompletedStripeConnect|StripeConnectOnboardingView"
    - from: "StripeConnectViewModel.swift"
      to: "DriverAPIClient.swift"
      via: "createConnectAccount, createAccountLink, getConnectStatus"
      pattern: "createConnectAccount|createAccountLink|getConnectStatus"
    - from: "StripeConnectOnboardingView.swift"
      to: "SFSafariViewController"
      via: "sheet presentation of Safari view for onboarding URL"
      pattern: "SafariView|SFSafariViewController"
---

<objective>
Implement mandatory Stripe Connect onboarding for drivers and update payout settings with Connect status badge.

Purpose: Drivers must set up Stripe Connect to receive payouts before accessing the app. This implements the locked decision that Connect setup is required as part of initial driver signup, blocking job feed access until complete. Also updates PayoutSettingsView to show Connect status instead of manual bank entry. (PAY-06 primarily, supports PAY-04)

Output: StripeConnectOnboardingView (mandatory gate), StripeConnectViewModel, updated app entry point, updated PayoutSettingsView with status badges.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-payments-integration/03-RESEARCH.md
@.planning/phases/03-payments-integration/03-02-SUMMARY.md
@JunkOS-Driver/JunkOSDriverApp.swift
@JunkOS-Driver/ViewModels/AppState.swift
@JunkOS-Driver/Services/DriverAPIClient.swift
@JunkOS-Driver/Views/Profile/PayoutSettingsView.swift
@JunkOS-Driver/Models/ContractorModels.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StripeConnectViewModel, OnboardingView, and API methods</name>
  <files>
    JunkOS-Driver/ViewModels/StripeConnectViewModel.swift
    JunkOS-Driver/Views/Auth/StripeConnectOnboardingView.swift
    JunkOS-Driver/Services/DriverAPIClient.swift
    JunkOS-Driver/JunkOSDriverApp.swift
    JunkOS-Driver/ViewModels/AppState.swift
  </files>
  <action>
**1. DriverAPIClient.swift — Add 3 new methods:**

Add API response models (at bottom of file or in a new section):
```swift
struct ConnectAccountResponse: Codable {
    let success: Bool
    let accountId: String?
    enum CodingKeys: String, CodingKey {
        case success
        case accountId = "account_id"
    }
}

struct ConnectAccountLinkResponse: Codable {
    let success: Bool
    let url: String
    let expiresAt: Int?
    enum CodingKeys: String, CodingKey {
        case success
        case url
        case expiresAt = "expires_at"
    }
}

struct ConnectStatusResponse: Codable {
    let success: Bool
    let status: String
    let chargesEnabled: Bool
    let payoutsEnabled: Bool
    let detailsSubmitted: Bool?
    enum CodingKeys: String, CodingKey {
        case success
        case status
        case chargesEnabled = "charges_enabled"
        case payoutsEnabled = "payouts_enabled"
        case detailsSubmitted = "details_submitted"
    }
}
```

Add methods to DriverAPIClient:
```swift
func createConnectAccount() async throws -> ConnectAccountResponse {
    try await request("/api/payments/connect/create-account", method: "POST")
}

func createAccountLink() async throws -> ConnectAccountLinkResponse {
    try await request("/api/payments/connect/account-link", method: "POST")
}

func getConnectStatus() async throws -> ConnectStatusResponse {
    try await request("/api/payments/connect/status")
}
```

**2. StripeConnectViewModel.swift — New file:**
- Use `@Observable` (driver app uses @Observable, not ObservableObject)
- Properties:
  - `var onboardingStatus: ConnectOnboardingStatus = .loading` (enum: `.loading`, `.notSetUp`, `.pendingVerification`, `.active`, `.failed(String)`)
  - `var showSafari = false`
  - `var accountLinkURL: URL?`
  - `var isCreatingAccount = false`
- Methods:
  - `func checkStatus() async` — calls `DriverAPIClient.shared.getConnectStatus()`, maps response.status string to enum
  - `func startOnboarding() async` — sets `isCreatingAccount = true`, calls `createConnectAccount()` first (idempotent), then `createAccountLink()`, sets `accountLinkURL` and `showSafari = true`, resets `isCreatingAccount`
  - `func onSafariDismissed() async` — calls `checkStatus()` again after user returns from browser

**3. StripeConnectOnboardingView.swift — New file:**
- Full-screen setup-required view matching driver design system (DriverSpacing, DriverTypography, Color.driverPrimary)
- Layout:
  - Large creditcard.circle icon (80pt, driverPrimary)
  - "Set Up Payments" title (DriverTypography.title)
  - "Connect your bank account to receive earnings from completed jobs." subtitle
  - Status indicator showing current status (loading spinner, "Not set up", "Pending verification")
  - "Connect with Stripe" primary button (DriverPrimaryButtonStyle)
  - Show loading spinner on button while `isCreatingAccount`
  - If status is `.pendingVerification`: show info text "Verification in progress. You can complete any remaining steps." and still allow tapping to re-open onboarding
- Sheet presentation: `.sheet(isPresented: $viewModel.showSafari)` containing a `SafariView` UIViewControllerRepresentable wrapper for SFSafariViewController
  - On `.onDisappear` of sheet: call `viewModel.onSafariDismissed()`
- `.task` modifier: call `viewModel.checkStatus()` on appear
- Create `SafariView: UIViewControllerRepresentable` struct that wraps `SFSafariViewController(url:)` with `import SafariServices`

**4. AppState.swift — Add Connect status tracking:**
- Add computed property: `var hasCompletedStripeConnect: Bool` that returns `contractorProfile?.stripeConnectId != nil` (basic check — the onboarding view does the detailed API status check)
- Note: ContractorProfile already has `stripeConnectId` field

**5. JunkOSDriverApp.swift — Gate behind Connect setup:**
- Add a new condition AFTER `!appState.isRegistered` check and BEFORE `DriverTabView`:
  ```swift
  } else if !appState.hasCompletedStripeConnect {
      StripeConnectOnboardingView(appState: appState)
  } else {
  ```
- This ensures: Splash → Onboarding → Auth → Role → Registration → **Stripe Connect Setup** → Main App
- The StripeConnectOnboardingView should accept appState as `@Bindable var appState: AppState` so it can reload the contractor profile after Connect completion to update `hasCompletedStripeConnect`
- After successful Connect verification in StripeConnectOnboardingView, reload profile: `await appState.loadContractorProfile()` which will update `contractorProfile.stripeConnectId` and allow progression to DriverTabView

**Do NOT:**
- Allow skipping Connect setup (locked decision: mandatory before app access)
- Cache account link URLs (they expire in 5 minutes)
- Use WKWebView (use SFSafariViewController per locked decision)
- Use embedded Connect components (beta, use hosted per locked decision)
  </action>
  <verify>
Read all created/modified files and verify:
1. StripeConnectViewModel has checkStatus, startOnboarding, onSafariDismissed methods
2. StripeConnectOnboardingView uses SFSafariViewController via SafariView wrapper
3. JunkOSDriverApp gates DriverTabView behind Connect setup
4. DriverAPIClient has all 3 Connect methods
5. AppState has hasCompletedStripeConnect computed property
  </verify>
  <done>
Driver app gates access behind mandatory Stripe Connect setup. StripeConnectOnboardingView presents SFSafariViewController for hosted onboarding. Status checked on return from browser. Driver cannot reach main tab view without Connect setup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace PayoutSettingsView with Connect status and onboarding link</name>
  <files>
    JunkOS-Driver/Views/Profile/PayoutSettingsView.swift
  </files>
  <action>
**Replace the existing manual bank account form** with a Stripe Connect status view:

The current PayoutSettingsView has a manual bank account form (routing number, account number) that simulates success. Replace this entirely with a Stripe Connect-driven view.

**New PayoutSettingsView layout:**

1. **Status Card** at top (replaces old PayoutStatusCard):
   - Badge showing one of three states:
     - "Not set up" — yellow warning icon + badge
     - "Pending verification" — orange clock icon + badge
     - "Active" — green checkmark icon + badge
   - Description text for each state

2. **Action Section:**
   - If not set up: "Set Up Stripe Connect" primary button
   - If pending: "Complete Setup" button + "Verification is in progress" info text
   - If active: "Manage Payout Account" button (opens Stripe Express dashboard link) + "Connected" confirmation
   - All buttons open SFSafariViewController with fresh account link (same pattern as onboarding view)

3. **Info Section:**
   - "How payouts work" expandable section:
     - "You earn 80% of each completed job"
     - "Payouts are sent after each job is marked complete"
     - "Funds typically arrive in 1-2 business days"
   - Security note (keep existing lock.shield icon + text about Stripe encryption)

4. Remove all manual bank form fields (accountHolderName, routingNumber, accountNumber, confirmAccountNumber, accountType)

**Implementation:**
- Add `@State private var viewModel = StripeConnectViewModel()` (reuse the same ViewModel)
- Add `.task { await viewModel.checkStatus() }` on appear
- Add `.sheet(isPresented: $viewModel.showSafari)` for SafariView
- Use `viewModel.onboardingStatus` to drive which card/button is shown
- Keep navigation title "Payout Method"

**Do NOT:**
- Show full job price anywhere (only driver's take)
- Keep manual bank form (Stripe Connect handles this)
  </action>
  <verify>
Read PayoutSettingsView.swift and verify:
1. No manual bank form fields (accountHolderName, routingNumber, etc.)
2. Shows Connect status badge (not set up / pending / active)
3. Action button opens SFSafariViewController for onboarding
4. Uses StripeConnectViewModel for state
  </verify>
  <done>
PayoutSettingsView shows Stripe Connect status badge with action buttons. Manual bank form removed. Active status shows green badge. Setup/pending shows appropriate action buttons with SFSafariViewController.
  </done>
</task>

</tasks>

<verification>
1. StripeConnectOnboardingView blocks app access until Connect setup complete
2. JunkOSDriverApp has Connect gate after registration, before main tabs
3. PayoutSettingsView shows status badge, no manual bank form
4. SFSafariViewController used for all Stripe Connect web flows
5. Account links generated fresh on each tap (not cached)
6. AppState.hasCompletedStripeConnect derives from contractor profile
</verification>

<success_criteria>
- New driver sees Connect setup screen after registration (before main app)
- Tapping "Connect with Stripe" opens SFSafariViewController
- Returning from browser checks status and progresses to main app if complete
- PayoutSettingsView in profile shows Connect status badge with action buttons
- No path to job feed without Connect setup complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-payments-integration/03-03-SUMMARY.md`
</output>
