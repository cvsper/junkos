---
phase: 05-volume-adjustment
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - JunkOS-Clean/JunkOS/Managers/NotificationManager.swift
  - JunkOS-Clean/JunkOS/Services/APIClient.swift
  - JunkOS-Clean/JunkOS/Views/OrdersView.swift
  - JunkOS-Clean/JunkOS/Models/APIModels.swift
autonomous: true

must_haves:
  truths:
    - "Customer receives push notification with new price and approve/decline action buttons"
    - "Customer can approve new price from notification action (job continues at updated price)"
    - "Customer can decline new price from notification action (job cancelled, trip fee charged)"
    - "In-app UI shows volume adjustment pending status with approve/decline buttons as fallback"
  artifacts:
    - path: "JunkOS-Clean/JunkOS/Managers/NotificationManager.swift"
      provides: "VOLUME_ADJUSTMENT notification category with approve/decline actions"
      contains: "VOLUME_ADJUSTMENT"
    - path: "JunkOS-Clean/JunkOS/Services/APIClient.swift"
      provides: "approveVolumeAdjustment and declineVolumeAdjustment API methods"
      contains: "approveVolumeAdjustment"
    - path: "JunkOS-Clean/JunkOS/Views/OrdersView.swift"
      provides: "Volume adjustment pending banner with approve/decline buttons"
      contains: "volumeAdjustment"
    - path: "JunkOS-Clean/JunkOS/Models/APIModels.swift"
      provides: "Volume adjustment fields in BookingResponse model"
      contains: "volumeAdjustmentProposed"
  key_links:
    - from: "JunkOS-Clean/JunkOS/Managers/NotificationManager.swift"
      to: "APIClient.shared.approveVolumeAdjustment"
      via: "UNNotificationAction APPROVE_VOLUME triggers API call"
      pattern: "APPROVE_VOLUME"
    - from: "JunkOS-Clean/JunkOS/Managers/NotificationManager.swift"
      to: "APIClient.shared.declineVolumeAdjustment"
      via: "UNNotificationAction DECLINE_VOLUME triggers API call"
      pattern: "DECLINE_VOLUME"
    - from: "JunkOS-Clean/JunkOS/Views/OrdersView.swift"
      to: "APIClient approve/decline methods"
      via: "In-app fallback buttons call same endpoints"
      pattern: "(approve|decline)VolumeAdjustment"
---

<objective>
Add volume adjustment notification handling to the customer iOS app: actionable push notification with approve/decline buttons, in-app fallback UI, and API integration for both actions.

Purpose: Customers can instantly approve or decline price adjustments from their lock screen notification, or from an in-app banner if the app is open.
Output: Updated NotificationManager with VOLUME_ADJUSTMENT category, APIClient methods, OrdersView banner.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-volume-adjustment/05-RESEARCH.md
@.planning/phases/05-volume-adjustment/05-01-SUMMARY.md
@.planning/phases/04-dispatch-system/04-03-SUMMARY.md

@JunkOS-Clean/JunkOS/Managers/NotificationManager.swift
@JunkOS-Clean/JunkOS/Services/APIClient.swift
@JunkOS-Clean/JunkOS/Views/OrdersView.swift
@JunkOS-Clean/JunkOS/Models/APIModels.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add VOLUME_ADJUSTMENT notification category with approve/decline actions</name>
  <files>JunkOS-Clean/JunkOS/Managers/NotificationManager.swift, JunkOS-Clean/JunkOS/Services/APIClient.swift, JunkOS-Clean/JunkOS/Models/APIModels.swift</files>
  <action>
  **NotificationManager.swift — Add volumeAdjustment to NotificationCategory enum:**
  Add new case: `case volumeAdjustment = "VOLUME_ADJUSTMENT"` with title "Volume Adjustment".

  **Update registerNotificationCategories() method:**
  Replace the generic loop with explicit category registration that includes actions for VOLUME_ADJUSTMENT:
  ```swift
  private func registerNotificationCategories() {
      // Standard categories (no actions)
      var categories = Set<UNNotificationCategory>()
      for category in NotificationCategory.allCases where category != .volumeAdjustment {
          categories.insert(UNNotificationCategory(
              identifier: category.rawValue,
              actions: [],
              intentIdentifiers: [],
              options: []
          ))
      }

      // Volume adjustment category with approve/decline actions
      let approveAction = UNNotificationAction(
          identifier: "APPROVE_VOLUME",
          title: "Approve New Price",
          options: [.foreground]
      )
      let declineAction = UNNotificationAction(
          identifier: "DECLINE_VOLUME",
          title: "Decline & Cancel",
          options: [.destructive, .foreground]
      )
      let volumeCategory = UNNotificationCategory(
          identifier: NotificationCategory.volumeAdjustment.rawValue,
          actions: [approveAction, declineAction],
          intentIdentifiers: [],
          options: [.customDismissAction]
      )
      categories.insert(volumeCategory)

      UNUserNotificationCenter.current().setNotificationCategories(categories)
  }
  ```

  **Update didReceive notification response handler:**
  In `userNotificationCenter(_:didReceive:withCompletionHandler:)`, add handling for the volume adjustment action identifiers BEFORE the existing category matching:
  ```swift
  let actionIdentifier = response.actionIdentifier

  // Handle volume adjustment actions
  if actionIdentifier == "APPROVE_VOLUME" || actionIdentifier == "DECLINE_VOLUME" {
      let userInfo = response.notification.request.content.userInfo
      if let jobId = userInfo["job_id"] as? String {
          if actionIdentifier == "APPROVE_VOLUME" {
              Task {
                  try? await APIClient.shared.approveVolumeAdjustment(jobId: jobId)
              }
          } else {
              Task {
                  try? await APIClient.shared.declineVolumeAdjustment(jobId: jobId)
              }
          }
      }
      completionHandler()
      return
  }
  ```

  Also add "volume_adjustment" to the type fallback switch in the else-if branch:
  ```swift
  case "volume_adjustment":
      handleNotificationAction(for: .volumeAdjustment, userInfo: userInfo)
  ```

  **APIClient.swift — Add volume adjustment API methods:**
  Add after existing methods:
  ```swift
  // MARK: - Volume Adjustment

  func approveVolumeAdjustment(jobId: String) async throws -> [String: Any] {
      let request = try createRequest(
          endpoint: "/api/jobs/\(jobId)/volume/approve",
          method: "POST"
      )
      let (data, response) = try await session.data(for: request)
      guard let http = response as? HTTPURLResponse, http.statusCode == 200 else {
          throw APIClientError.serverError("Failed to approve volume adjustment")
      }
      return (try? JSONSerialization.jsonObject(with: data) as? [String: Any]) ?? [:]
  }

  func declineVolumeAdjustment(jobId: String) async throws -> [String: Any] {
      let request = try createRequest(
          endpoint: "/api/jobs/\(jobId)/volume/decline",
          method: "POST"
      )
      let (data, response) = try await session.data(for: request)
      guard let http = response as? HTTPURLResponse, http.statusCode == 200 else {
          throw APIClientError.serverError("Failed to decline volume adjustment")
      }
      return (try? JSONSerialization.jsonObject(with: data) as? [String: Any]) ?? [:]
  }
  ```

  **APIModels.swift — Add volume adjustment fields to BookingResponse:**
  Add these optional fields to the existing BookingResponse struct (the model used by OrdersView to display bookings):
  ```swift
  let volumeAdjustmentProposed: Bool?
  let adjustedPrice: Double?
  let adjustedVolume: Double?
  ```
  Add corresponding CodingKeys:
  ```swift
  case volumeAdjustmentProposed = "volume_adjustment_proposed"
  case adjustedPrice = "adjusted_price"
  case adjustedVolume = "adjusted_volume"
  ```
  </action>
  <verify>Grep for "VOLUME_ADJUSTMENT" in NotificationManager.swift — should find category registration. Grep for "APPROVE_VOLUME" in NotificationManager.swift — should find action handling. Grep for "approveVolumeAdjustment" in APIClient.swift — should find method. Grep for "volumeAdjustmentProposed" in APIModels.swift — should find field.</verify>
  <done>NotificationManager registers VOLUME_ADJUSTMENT category with Approve/Decline action buttons. Tapping notification actions calls approve/decline API endpoints. APIClient has both methods. BookingResponse model includes volume adjustment fields.</done>
</task>

<task type="auto">
  <name>Task 2: Add in-app volume adjustment pending banner to OrdersView</name>
  <files>JunkOS-Clean/JunkOS/Views/OrdersView.swift</files>
  <action>
  **OrdersView.swift — Add volume adjustment banner for bookings with pending adjustment:**

  In the booking card/row rendering (inside the ForEach over bookings), add a conditional banner that appears when `booking.volumeAdjustmentProposed == true`:

  After the existing booking card content (status badge, driver name, etc.), add:
  ```swift
  // Volume adjustment pending banner
  if booking.volumeAdjustmentProposed == true {
      VStack(spacing: 8) {
          HStack(spacing: 6) {
              Image(systemName: "exclamationmark.triangle.fill")
                  .foregroundStyle(.orange)
              Text("Price Adjustment Required")
                  .font(.subheadline.weight(.semibold))
          }

          if let adjustedPrice = booking.adjustedPrice {
              Text("New price: $\(adjustedPrice, specifier: "%.2f")")
                  .font(.subheadline)
                  .foregroundStyle(.secondary)
          }

          HStack(spacing: 12) {
              Button {
                  Task {
                      try? await APIClient.shared.approveVolumeAdjustment(jobId: booking.id)
                      // Refresh bookings after action
                      await loadBookings()
                  }
              } label: {
                  Text("Approve")
                      .font(.subheadline.weight(.medium))
                      .foregroundStyle(.white)
                      .frame(maxWidth: .infinity)
                      .padding(.vertical, 10)
                      .background(Color.green)
                      .clipShape(RoundedRectangle(cornerRadius: 8))
              }

              Button {
                  Task {
                      try? await APIClient.shared.declineVolumeAdjustment(jobId: booking.id)
                      // Refresh bookings after action
                      await loadBookings()
                  }
              } label: {
                  Text("Decline")
                      .font(.subheadline.weight(.medium))
                      .foregroundStyle(.white)
                      .frame(maxWidth: .infinity)
                      .padding(.vertical, 10)
                      .background(Color.red)
                      .clipShape(RoundedRectangle(cornerRadius: 8))
              }
          }
      }
      .padding(12)
      .background(Color.orange.opacity(0.1))
      .clipShape(RoundedRectangle(cornerRadius: 12))
      .padding(.horizontal)
  }
  ```

  If `loadBookings` is the existing function that refreshes the booking list (check the actual function name in OrdersView — it might be `fetchBookings` or similar), use the correct name. The key pattern: after approve or decline, refresh the list so the banner disappears.

  Also add a foreground notification listener for `volumeAdjustment` — when the app receives a volume adjustment push while in foreground, auto-refresh the booking list. Add to the existing `.onReceive` chain or add:
  ```swift
  .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("volumeAdjustmentReceived"))) { _ in
      Task { await loadBookings() }
  }
  ```
  (Note: this requires NotificationManager to post "volumeAdjustmentReceived" when it handles a volume_adjustment notification type — add this to the handleNotificationAction method for .volumeAdjustment case.)
  </action>
  <verify>Grep for "Price Adjustment Required" in OrdersView.swift — should find the banner. Grep for "volumeAdjustmentProposed" in OrdersView.swift — should find the conditional. Both "Approve" and "Decline" buttons should be present.</verify>
  <done>OrdersView shows orange volume adjustment banner with price info and Approve/Decline buttons when a booking has volumeAdjustmentProposed == true. Buttons call API endpoints and refresh the booking list. Foreground push notifications auto-refresh the list.</done>
</task>

</tasks>

<verification>
1. NotificationManager registers VOLUME_ADJUSTMENT category with APPROVE_VOLUME and DECLINE_VOLUME actions
2. Tapping "Approve New Price" on notification triggers POST /api/jobs/<id>/volume/approve
3. Tapping "Decline & Cancel" on notification triggers POST /api/jobs/<id>/volume/decline
4. In-app OrdersView shows volume adjustment banner with Approve/Decline buttons for pending adjustments
5. In-app Approve/Decline buttons call same API endpoints and refresh list
6. BookingResponse model includes volumeAdjustmentProposed, adjustedPrice, adjustedVolume fields
7. Foreground volume_adjustment notifications trigger list refresh
</verification>

<success_criteria>
Customer can approve or decline volume adjustments from both push notification actions (lock screen) and in-app buttons (OrdersView). Both paths hit the backend API correctly and update the UI.
</success_criteria>

<output>
After completion, create `.planning/phases/05-volume-adjustment/05-03-SUMMARY.md`
</output>
