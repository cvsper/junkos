---
phase: 05-volume-adjustment
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified: []
autonomous: true
gap_closure: false

must_haves:
  truths:
    - "Driver can input actual volume on arrival when estimate is incorrect (VOL-01)"
    - "Customer receives push notification with new price for approval (VOL-02)"
    - "Customer can approve new price and job continues at updated price (VOL-03)"
    - "Customer can decline new price and job is cancelled with trip fee (VOL-04)"
    - "Backend recalculates price using driver's volume input (VOL-05)"
  artifacts: []
  key_links:
    - from: "backend/routes/drivers.py"
      to: "JunkOS-Driver/Views/ActiveJob/VolumeAdjustmentView.swift"
      via: "POST /api/drivers/jobs/<id>/volume API call"
      pattern: "proposeVolumeAdjustment"
    - from: "backend/push_notifications.py"
      to: "JunkOS-Clean/JunkOS/Managers/NotificationManager.swift"
      via: "APNs push with VOLUME_ADJUSTMENT category"
      pattern: "VOLUME_ADJUSTMENT"
    - from: "JunkOS-Clean/JunkOS/Managers/NotificationManager.swift"
      to: "backend/routes/jobs.py"
      via: "POST /api/jobs/<id>/volume/approve and /decline"
      pattern: "(approve|decline)VolumeAdjustment"
    - from: "backend/routes/jobs.py"
      to: "JunkOS-Driver/Services/SocketIOManager.swift"
      via: "Socket.IO volume:approved / volume:declined events"
      pattern: "volume:(approved|declined)"
---

<objective>
End-to-end verification of all 5 VOL requirements across backend, driver iOS app, and customer iOS app.

Purpose: Confirms the complete volume adjustment workflow before marking Phase 5 as complete.
Output: Verification results documenting each requirement status.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-volume-adjustment/05-01-SUMMARY.md
@.planning/phases/05-volume-adjustment/05-02-SUMMARY.md
@.planning/phases/05-volume-adjustment/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify end-to-end volume adjustment pipeline across all subsystems</name>
  <files></files>
  <action>
  Trace the complete volume adjustment data flow across all 3 subsystems (backend, driver app, customer app) and verify each VOL requirement:

  **VOL-01: Driver can input actual volume on arrival when estimate is incorrect**
  - Verify VolumeAdjustmentView.swift exists with TextField for volume input
  - Verify ActiveJobView.swift shows "Adjust Volume" button/link when job status is .arrived
  - Verify VolumeAdjustmentViewModel.swift has proposeAdjustment method
  - Verify DriverAPIClient.swift has proposeVolumeAdjustment method calling POST /api/drivers/jobs/<id>/volume

  **VOL-02: Customer receives push notification with new price for approval**
  - Verify backend/routes/drivers.py propose_volume_adjustment endpoint sends push with category="VOLUME_ADJUSTMENT"
  - Verify backend/push_notifications.py includes category in APNs aps payload
  - Verify JunkOS-Clean NotificationManager.swift registers VOLUME_ADJUSTMENT category with APPROVE_VOLUME and DECLINE_VOLUME actions
  - Verify push data includes job_id and new_price

  **VOL-03: Customer can approve new price (job continues at updated price)**
  - Verify NotificationManager handles APPROVE_VOLUME action → calls APIClient.approveVolumeAdjustment
  - Verify APIClient.swift has approveVolumeAdjustment method calling POST /api/jobs/<id>/volume/approve
  - Verify backend approve endpoint: updates Stripe PaymentIntent amount, updates job.total_price, clears volume_adjustment_proposed
  - Verify Socket.IO volume:approved event emitted to driver room
  - Verify driver ViewModel receives approval via NotificationCenter bridge
  - Verify in-app OrdersView Approve button also calls the same endpoint

  **VOL-04: Customer can decline new price (job cancelled, customer charged trip fee)**
  - Verify NotificationManager handles DECLINE_VOLUME action → calls APIClient.declineVolumeAdjustment
  - Verify APIClient.swift has declineVolumeAdjustment method calling POST /api/jobs/<id>/volume/decline
  - Verify backend decline endpoint: sets Stripe PaymentIntent to trip fee ($50), cancels job, sets cancellation_fee
  - Verify Socket.IO volume:declined event emitted to driver room
  - Verify driver ViewModel receives decline via NotificationCenter bridge and shows trip fee
  - Verify in-app OrdersView Decline button also calls the same endpoint

  **VOL-05: Backend recalculates price using driver's volume input**
  - Verify propose endpoint maps actual_volume to item quantity via volume tier logic
  - Verify calculate_estimate is called with mapped items
  - Verify auto-approve logic: if new_price <= original price, auto-approve without customer notification
  - Verify response includes new_price and original_price

  **Cross-cutting concerns:**
  - Verify idempotency: approve/decline return 409 if volume_adjustment_proposed is already False
  - Verify authorization: only assigned driver can propose, only job customer can approve/decline
  - Verify Stripe error handling: try/except around all Stripe calls
  - Verify Job model has volume_adjustment_proposed, adjusted_volume, adjusted_price fields in to_dict()

  For each requirement, search for the specific code patterns using grep and read relevant file sections. Document findings in the summary.
  </action>
  <verify>All 5 VOL requirements have verified code paths with no broken links in the data flow chain.</verify>
  <done>End-to-end verification complete: all 5 VOL requirements confirmed with specific code references. Volume adjustment pipeline spans backend (3 endpoints + model + push + socket), driver app (view + viewmodel + API + socket listener), and customer app (notification category + actions + API + in-app banner).</done>
</task>

</tasks>

<verification>
Complete end-to-end trace from driver volume input through backend processing through customer notification through customer response back to driver feedback. All 5 VOL requirements verified with code references.
</verification>

<success_criteria>
All 5 VOL requirements verified as implemented and connected across backend, driver iOS app, and customer iOS app. No broken links in the data flow.
</success_criteria>

<output>
After completion, create `.planning/phases/05-volume-adjustment/05-04-SUMMARY.md`
</output>
