---
phase: 06-real-time-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - JunkOS-Driver/Managers/LocationManager.swift
  - JunkOS-Driver/ViewModels/ActiveJobViewModel.swift
  - JunkOS-Driver/Services/SocketIOManager.swift
  - backend/routes/drivers.py
autonomous: true

must_haves:
  truths:
    - "Driver app streams GPS coordinates to backend via Socket.IO every 5 seconds during active jobs"
    - "Customer receives push notifications for arrived and started status transitions (not just en_route and completed)"
    - "Driver location streaming starts when job status changes to en_route and stops on completed"
  artifacts:
    - path: "JunkOS-Driver/Managers/LocationManager.swift"
      provides: "Throttled location callback with 5-second interval and 20m distance filter"
      contains: "emitInterval"
    - path: "JunkOS-Driver/ViewModels/ActiveJobViewModel.swift"
      provides: "Location streaming lifecycle tied to job status transitions"
      contains: "startLocationStreaming"
    - path: "backend/routes/drivers.py"
      provides: "Push notifications for arrived and started status changes"
      contains: "arrived"
  key_links:
    - from: "JunkOS-Driver/Managers/LocationManager.swift"
      to: "JunkOS-Driver/Services/SocketIOManager.swift"
      via: "onLocationUpdate callback emits to Socket.IO"
      pattern: "emitLocation"
    - from: "JunkOS-Driver/ViewModels/ActiveJobViewModel.swift"
      to: "JunkOS-Driver/Managers/LocationManager.swift"
      via: "startTracking/stopTracking on status change"
      pattern: "startTracking|stopTracking"
    - from: "backend/routes/drivers.py"
      to: "backend/notifications.py"
      via: "send_push_notification for arrived/started"
      pattern: "send_push_notification"
---

<objective>
Wire driver GPS streaming during active jobs and add missing push notifications for all status transitions.

Purpose: TRACK-03 requires driver location to stream via Socket.IO during active jobs. TRACK-02 requires push notifications for each status change — the backend currently only sends push for en_route and completed, missing arrived and started.

Output: Driver app streams throttled GPS via Socket.IO when job is active (en_route through started). Backend sends push notifications for all four status transitions.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-real-time-tracking/06-RESEARCH.md
@JunkOS-Driver/Managers/LocationManager.swift
@JunkOS-Driver/ViewModels/ActiveJobViewModel.swift
@JunkOS-Driver/Services/SocketIOManager.swift
@backend/routes/drivers.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire driver location streaming during active jobs</name>
  <files>
    JunkOS-Driver/Managers/LocationManager.swift
    JunkOS-Driver/ViewModels/ActiveJobViewModel.swift
    JunkOS-Driver/Services/SocketIOManager.swift
  </files>
  <action>
  **LocationManager.swift enhancements:**
  1. Change `desiredAccuracy` from `kCLLocationAccuracyBest` to `kCLLocationAccuracyNearestTenMeters` (battery optimization per research)
  2. Add `distanceFilter = 20` in init (only update after 20 meters of movement)
  3. Add throttling properties: `private var lastEmitTime: Date?` and `private let emitInterval: TimeInterval = 5.0`
  4. Add `var activeJobId: String?` and `var contractorId: String?` properties for streaming context
  5. In `locationManager(_:didUpdateLocations:)`, after setting `currentLocation`, add throttled Socket.IO emission:
     - Check if `activeJobId` is set (means we're on an active job)
     - Check if enough time has passed since `lastEmitTime` (5 second interval)
     - If both pass, call `SocketIOManager.shared.emitLocation(lat:lng:contractorId:jobId:)` and update `lastEmitTime`
  6. Add `func startActiveJobTracking(jobId: String, contractorId: String)` that sets `activeJobId`/`contractorId` and calls `startTracking()`
  7. Add `func stopActiveJobTracking()` that clears `activeJobId`/`contractorId`, resets `lastEmitTime`, and calls `stopTracking()`

  **SocketIOManager.swift** — no changes needed, `emitLocation(lat:lng:contractorId:jobId:)` already exists.

  **ActiveJobViewModel.swift enhancements:**
  1. Add `private let locationManager = LocationManager()` property
  2. In `updateStatus()`, after successful status update:
     - When `status == "en_route"`: call `locationManager.startActiveJobTracking(jobId: jobId, contractorId: contractorId)` where contractorId comes from `DriverAPIClient.shared` or stored auth state. Get contractorId from `KeychainHelper.loadString(forKey: "contractorId")` or equivalent — check how driver app stores contractor ID.
     - When `status == "completed"`: call `locationManager.stopActiveJobTracking()`
  3. To get contractorId: look at how DriverAPIClient or AuthenticationManager stores the contractor's ID. Use whatever pattern the driver app already uses. If stored in UserDefaults as "contractorId", use that.

  **Important:** Do NOT use `kCLLocationAccuracyBest` — it drains battery. Use `kCLLocationAccuracyNearestTenMeters`.
  Do NOT set `pausesLocationUpdatesAutomatically = true` — it will stop updates when driver is stationary at a red light.
  </action>
  <verify>
  Build the driver Xcode project (JunkOS-Driver) and verify no compilation errors. Verify LocationManager has throttling logic with 5-second interval. Verify ActiveJobViewModel calls startActiveJobTracking on en_route and stopActiveJobTracking on completed.
  </verify>
  <done>
  Driver app starts streaming GPS via Socket.IO when job transitions to en_route, throttles to 1 emission per 5 seconds with 20m distance filter, and stops streaming when job completes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add push notifications for arrived and started status transitions</name>
  <files>
    backend/routes/drivers.py
  </files>
  <action>
  In `update_job_status()` function in `backend/routes/drivers.py`, the existing notification block (around line 385-430) already sends push for `en_route` and `completed`. Add push notifications for `arrived` and `started`:

  1. After the existing `elif new_status == "completed":` block (around line 405), add:

  ```python
  elif new_status == "arrived":
      if customer:
          send_push_notification(
              customer.id, "Driver Has Arrived",
              "Your driver has arrived at the location.",
              {"job_id": job.id, "status": "arrived"},
          )

  elif new_status == "started":
      if customer:
          send_push_notification(
              customer.id, "Job In Progress",
              "Your driver has started the job.",
              {"job_id": job.id, "status": "started"},
          )
  ```

  2. Ensure the `send_push_notification` import at the top of the try block already includes it (it does — check line 386-389).

  3. Also add `send_push_notification` calls with category identifiers for deep linking. Include `"category"` key in the data dict: `"category": "job_arrived"` and `"category": "job_started"` respectively. Also add category to the existing en_route and completed push calls if not already present.

  **Important:** Keep all push calls inside the existing try/except block so notification failures never break the status update endpoint. Use lazy import pattern consistent with the existing code.
  </action>
  <verify>
  Read `backend/routes/drivers.py` and verify that `update_job_status` now sends push notifications for all four status transitions: en_route, arrived, started, completed. Each push call should be inside the try/except block and include a category field in the data dict.
  </verify>
  <done>
  Backend sends APNs push notification to the customer for every job status transition (en_route, arrived, started, completed) with appropriate titles and category identifiers for deep linking.
  </done>
</task>

</tasks>

<verification>
1. Driver Xcode project compiles without errors
2. LocationManager has 5-second throttle interval and 20m distance filter
3. ActiveJobViewModel starts tracking on en_route, stops on completed
4. Backend sends push for all 4 status transitions (en_route, arrived, started, completed)
5. All push calls are inside try/except (non-blocking)
</verification>

<success_criteria>
- Driver location streams to backend every 5 seconds via Socket.IO when job is en_route, arrived, or started
- Customer receives push notification for each of the 4 job status transitions
- No compilation errors in driver Xcode project
</success_criteria>

<output>
After completion, create `.planning/phases/06-real-time-tracking/06-01-SUMMARY.md`
</output>
