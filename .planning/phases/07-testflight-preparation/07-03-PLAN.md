---
phase: 07-testflight-preparation
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Production backend is reachable and responds to health check"
    - "Both apps run on physical device without crashes"
    - "End-to-end flow verified: customer books, driver accepts, driver completes, payment processes"
    - "Both apps archived and uploaded to App Store Connect without validation errors"
  artifacts: []
  key_links:
    - from: "JunkOS-Clean (Release build)"
      to: "https://junkos-backend.onrender.com"
      via: "Config.swift production URL"
      pattern: "junkos-backend.onrender.com"
    - from: "JunkOS-Driver (Release build)"
      to: "https://junkos-backend.onrender.com"
      via: "AppConfig.swift production URL"
      pattern: "junkos-backend.onrender.com"
---

<objective>
Test production backend connectivity and verify both apps end-to-end on physical devices, then archive and upload to App Store Connect.

Purpose: TestFlight builds must work with the production backend. Physical device testing catches issues that Simulator cannot (push notifications, location services, memory pressure). App Store Connect upload validation is the final gate before TestFlight distribution.

Output: Both apps verified on physical device and uploaded to App Store Connect.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-testflight-preparation/07-RESEARCH.md
@.planning/phases/07-testflight-preparation/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify production backend reachability and API endpoints</name>
  <files></files>
  <action>
    Test the production backend to confirm it is deployed and accepting requests:

    1. **Health check:**
       ```bash
       curl -s -o /dev/null -w "%{http_code}" https://junkos-backend.onrender.com/health
       # Should return 200
       ```
       If no /health endpoint, try:
       ```bash
       curl -s -o /dev/null -w "%{http_code}" https://junkos-backend.onrender.com/
       ```

    2. **Auth endpoint (Apple Sign In):**
       ```bash
       curl -s -X POST https://junkos-backend.onrender.com/api/auth/apple \
         -H "Content-Type: application/json" \
         -d '{"identity_token": "test", "authorization_code": "test"}' \
         -w "\n%{http_code}"
       # Should return 401 (invalid token) not 404 (endpoint missing) or 500 (server error)
       ```

    3. **Jobs endpoint (requires auth):**
       ```bash
       curl -s -X GET https://junkos-backend.onrender.com/api/jobs \
         -H "Authorization: Bearer invalid" \
         -w "\n%{http_code}"
       # Should return 401 (unauthorized) not 404 or 500
       ```

    4. **Socket.IO availability:**
       ```bash
       curl -s "https://junkos-backend.onrender.com/socket.io/?transport=polling" \
         -w "\n%{http_code}"
       # Should return 200 with socket.io session data
       ```

    5. **Document results** in a brief test report. If backend is down (Render free tier sleeps after inactivity), note that the first request may take 30-60 seconds to wake.

    6. **If backend is unreachable:** Document the issue clearly for the checkpoint task. The user may need to deploy the backend or check Render dashboard.
  </action>
  <verify>
    - At least the root URL returns a non-500 HTTP status code
    - Auth endpoint returns 401 (not 404) confirming the route exists
    - Results documented in task output
  </verify>
  <done>Production backend reachability confirmed. API endpoints exist and respond correctly (auth returns 401 for invalid tokens, not 404).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Physical device testing and App Store Connect upload</name>
  <what-built>
    Both iOS apps (Umuve and Umuve Pro) have been prepared for TestFlight:
    - Push notification entitlements added (07-01)
    - Release builds compile successfully (07-01)
    - Privacy policy page created (07-02)
    - App Store metadata prepared (07-02)
    - Production backend connectivity verified (07-03 Task 1)
  </what-built>
  <how-to-verify>
    **Step 1: Deploy privacy policy**
    ```bash
    cd landing-page-premium && vercel --prod --yes
    ```
    Verify: Visit https://goumuve.com/privacy.html

    **Step 2: Test customer app on physical device**
    1. Open `JunkOS-Clean/JunkOS.xcodeproj` in Xcode
    2. Select your physical iPhone as target device
    3. Edit Scheme > Run > Build Configuration > **Release**
    4. Build and run (Cmd+R)
    5. Test flow:
       - Launch app (should show onboarding or home screen)
       - Sign in with Apple
       - Start booking wizard (select service, enter address, set schedule)
       - Reach payment screen (Stripe payment sheet should appear)
       - Note: Payment will fail with placeholder keys - this is expected
    6. Change Build Configuration back to Debug after testing

    **Step 3: Test driver app on physical device**
    1. Open `JunkOS-Driver/JunkOS-Driver.xcodeproj` in Xcode
    2. Select your physical iPhone as target device
    3. Edit Scheme > Run > Build Configuration > **Release**
    4. Build and run (Cmd+R)
    5. Test flow:
       - Launch app (should show onboarding or home screen)
       - Sign in with Apple
       - Complete Stripe Connect onboarding (or skip if in test mode)
       - Toggle availability online
       - Check job feed loads (may be empty - that's OK)
    6. Change Build Configuration back to Debug after testing

    **Step 4: Archive and upload customer app**
    1. In Xcode, select "Any iOS Device (arm64)" as destination
    2. Product > Archive (wait 1-5 minutes)
    3. In Organizer, select the archive > Validate App
    4. Fix any validation errors
    5. Distribute App > App Store Connect > Upload
    6. Wait 10-30 minutes for processing

    **Step 5: Archive and upload driver app**
    1. Same process as Step 4 for JunkOS-Driver
    2. Ensure build number is unique (currently Build 4, increment if needed)

    **Step 6: Verify in App Store Connect**
    1. Visit https://appstoreconnect.apple.com
    2. Check both apps show "Ready to Submit" or "Processing" status
    3. Add TestFlight beta test information:
       - Beta App Description (from app-store-metadata.md)
       - What to Test instructions
       - Feedback email: support@goumuve.com
    4. Enter Privacy Policy URL: https://goumuve.com/privacy.html
    5. Fill in App Privacy nutrition labels (from app-store-metadata.md)

    **Expected issues and fixes:**
    - "Missing Compliance" warning: Select "No" for encryption export (app uses HTTPS but no custom encryption)
    - Render backend cold start: First request may take 30-60s, retry if timeout
    - Stripe placeholder keys: Payments won't process - this is expected for initial TestFlight
  </how-to-verify>
  <resume-signal>Type "approved" if both apps uploaded successfully, or describe any issues encountered (build errors, validation failures, device testing problems).</resume-signal>
</task>

</tasks>

<verification>
1. Production backend responds to HTTP requests
2. Both apps tested on physical iPhone in Release configuration
3. Both apps archived and passed Xcode validation
4. Both apps uploaded to App Store Connect
5. App Store Connect shows builds in "Processing" or "Ready to Submit" state
6. Privacy policy URL entered in App Store Connect
7. TestFlight beta information filled in
</verification>

<success_criteria>
- Production backend is live and responding
- Both apps run on physical device without crashes in Release mode
- Both apps pass App Store Connect validation
- Both apps visible in TestFlight after processing completes
- Privacy policy accessible at public URL
</success_criteria>

<output>
After completion, create `.planning/phases/07-testflight-preparation/07-03-SUMMARY.md`
</output>
