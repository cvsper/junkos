---
phase: 07-testflight-preparation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - JunkOS-Clean/JunkOS/JunkOS.entitlements
  - JunkOS-Driver/JunkOS-Driver.entitlements
  - JunkOS-Driver/project.yml
  - JunkOS-Clean/JunkOS/Info.plist
autonomous: true

must_haves:
  truths:
    - "Both apps have push notification entitlements configured for production (aps-environment: production)"
    - "Customer app compiles for Release configuration targeting physical device without errors"
    - "Driver app compiles for Release configuration targeting physical device without errors"
    - "Both apps use production backend URL (junkos-backend.onrender.com) in Release builds"
  artifacts:
    - path: "JunkOS-Clean/JunkOS/JunkOS.entitlements"
      provides: "Push notification and Apple Pay entitlements for customer app"
      contains: "aps-environment"
    - path: "JunkOS-Driver/JunkOS-Driver.entitlements"
      provides: "Push notification entitlements for driver app"
      contains: "aps-environment"
    - path: "JunkOS-Driver/project.yml"
      provides: "Updated XcodeGen config with entitlements reference"
      contains: "entitlements"
  key_links:
    - from: "JunkOS-Clean/JunkOS/JunkOS.entitlements"
      to: "JunkOS-Clean/JunkOS.xcodeproj/project.pbxproj"
      via: "Xcode project references entitlements file"
      pattern: "JunkOS.entitlements"
    - from: "JunkOS-Driver/JunkOS-Driver.entitlements"
      to: "JunkOS-Driver/project.yml"
      via: "XcodeGen references entitlements in target settings"
      pattern: "entitlements"
---

<objective>
Fix entitlements and ensure both apps compile for Release configuration targeting physical devices.

Purpose: Both apps use push notifications (added in Phases 4-6) but neither has the required aps-environment entitlement. Without this, push notifications fail on production builds and App Store Connect validation rejects the binary. Both apps must also compile cleanly for Release builds to proceed with archiving and upload.

Output: Both apps compile for Release configuration with correct entitlements.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-testflight-preparation/07-RESEARCH.md
@JunkOS-Clean/JunkOS/JunkOS.entitlements
@JunkOS-Clean/JunkOS/Services/Config.swift
@JunkOS-Clean/JunkOS/Info.plist
@JunkOS-Driver/project.yml
@JunkOS-Driver/Config/Config.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add push notification entitlements to both apps</name>
  <files>
    JunkOS-Clean/JunkOS/JunkOS.entitlements
    JunkOS-Driver/JunkOS-Driver.entitlements
    JunkOS-Driver/project.yml
  </files>
  <action>
    1. **Customer app (JunkOS-Clean/JunkOS/JunkOS.entitlements):**
       - Add `aps-environment` key with value `production` to the existing entitlements plist
       - Keep existing Apple Pay merchant ID (`merchant.com.goumuve.app`)
       - The entitlements file already exists and is referenced by the Xcode project

    2. **Driver app (JunkOS-Driver/JunkOS-Driver.entitlements):**
       - Create new entitlements file at `JunkOS-Driver/JunkOS-Driver.entitlements`
       - Add `aps-environment` key with value `production`
       - Add `com.apple.developer.associated-domains` if needed for deep linking (optional, skip if not used)
       - Standard plist format matching customer app's entitlements structure

    3. **Driver app project.yml:**
       - Add `CODE_SIGN_ENTITLEMENTS: JunkOS-Driver.entitlements` to the target settings base section
       - This tells XcodeGen to reference the entitlements file when generating the project

    4. **Regenerate driver Xcode project:**
       - Run `cd JunkOS-Driver && xcodegen generate` to regenerate the .xcodeproj with entitlements reference

    NOTE: The `aps-environment` value should be `production` (not `development`). Xcode automatic signing with Debug builds will automatically use the development APS environment. The entitlements file declares the production environment which is what App Store Connect requires.
  </action>
  <verify>
    - `grep "aps-environment" JunkOS-Clean/JunkOS/JunkOS.entitlements` returns a match
    - `grep "aps-environment" JunkOS-Driver/JunkOS-Driver.entitlements` returns a match
    - `grep "entitlements" JunkOS-Driver/project.yml` returns a match
    - `cd JunkOS-Driver && xcodegen generate` completes without errors
  </verify>
  <done>Both apps have push notification entitlements configured for production. Driver app project regenerated with entitlements reference.</done>
</task>

<task type="auto">
  <name>Task 2: Verify Release build compilation for both apps</name>
  <files>
    JunkOS-Clean/JunkOS/Info.plist
  </files>
  <action>
    1. **Attempt customer app Release build:**
       ```bash
       cd JunkOS-Clean
       xcodebuild -project JunkOS.xcodeproj -scheme JunkOS -configuration Release -destination 'generic/platform=iOS' -quiet build 2>&1
       ```
       - If build fails, analyze errors and fix them (common issues: missing frameworks, deprecated APIs, code signing)
       - The `-destination 'generic/platform=iOS'` targets Any iOS Device (arm64), required for archives
       - `-quiet` reduces noise but still shows errors

    2. **Attempt driver app Release build:**
       ```bash
       cd JunkOS-Driver
       xcodebuild -project JunkOS-Driver.xcodeproj -scheme JunkOS-Driver -configuration Release -destination 'generic/platform=iOS' -quiet build 2>&1
       ```
       - If build fails, analyze and fix errors
       - Driver app has SocketIO package dependency - ensure it resolves

    3. **Fix any compilation errors found:**
       - Common issues in Release builds: `#if DEBUG`-only code paths missing else clause, optimization-level warnings, unavailable API calls
       - If Stripe publishable key placeholders cause issues, replace with test mode key format (pk_test_...) that is syntactically valid but still placeholder
       - Document all fixes made

    4. **Verify environment switching:**
       - Confirm that Release builds will use production URLs by checking Config.swift `#if DEBUG` / `#else` blocks
       - Both apps already have this pattern correctly implemented (verified in research)
  </action>
  <verify>
    - `xcodebuild -project JunkOS-Clean/JunkOS.xcodeproj -scheme JunkOS -configuration Release -destination 'generic/platform=iOS' build 2>&1 | tail -5` shows "BUILD SUCCEEDED"
    - `xcodebuild -project JunkOS-Driver/JunkOS-Driver.xcodeproj -scheme JunkOS-Driver -configuration Release -destination 'generic/platform=iOS' build 2>&1 | tail -5` shows "BUILD SUCCEEDED"
  </verify>
  <done>Both apps compile successfully for Release configuration targeting physical iOS devices. All build errors resolved.</done>
</task>

</tasks>

<verification>
1. Both entitlements files exist and contain `aps-environment` set to `production`
2. Customer app entitlements also retains Apple Pay merchant ID
3. Driver app project.yml references entitlements file
4. Both apps build successfully with `xcodebuild -configuration Release -destination 'generic/platform=iOS'`
5. No build warnings related to entitlements or code signing
</verification>

<success_criteria>
- Both apps compile for Release configuration without errors
- Push notification entitlements present in both apps
- Driver app XcodeGen project regenerated with entitlements
- Environment switching confirmed (Release = production backend URL)
</success_criteria>

<output>
After completion, create `.planning/phases/07-testflight-preparation/07-01-SUMMARY.md`
</output>
