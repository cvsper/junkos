---
phase: 02-pricing-booking
plan: 05
type: execute
wave: 4
depends_on: ["02-04"]
files_modified:
  - JunkOS-Clean/JunkOS/Views/BookingReviewView.swift
  - JunkOS-Clean/JunkOS/ViewModels/BookingReviewViewModel.swift
  - JunkOS-Clean/JunkOS/Views/BookingWizardView.swift
  - JunkOS-Clean/JunkOS/Services/APIClient.swift
autonomous: false

must_haves:
  truths:
    - "Customer sees full summary card: service type, address(es), photo thumbnails, date/time, price breakdown"
    - "Price breakdown is expandable with line items (Base Fee, Distance Fee, Service Multiplier)"
    - "Customer taps Confirm Booking and backend creates job with calculated price"
    - "Backend returns job_id confirming job creation"
    - "Review step plugs into BookingWizardView as step 4"
  artifacts:
    - path: "JunkOS-Clean/JunkOS/Views/BookingReviewView.swift"
      provides: "Review and confirmation screen with full summary"
      contains: "BookingReviewView"
    - path: "JunkOS-Clean/JunkOS/ViewModels/BookingReviewViewModel.swift"
      provides: "Job creation API call and submission state"
      contains: "BookingReviewViewModel"
    - path: "JunkOS-Clean/JunkOS/Services/APIClient.swift"
      provides: "Job creation API method and photo upload method"
      contains: "createJob"
  key_links:
    - from: "JunkOS-Clean/JunkOS/Views/BookingReviewView.swift"
      to: "JunkOS-Clean/JunkOS/ViewModels/BookingReviewViewModel.swift"
      via: "@StateObject"
      pattern: "BookingReviewViewModel"
    - from: "JunkOS-Clean/JunkOS/ViewModels/BookingReviewViewModel.swift"
      to: "JunkOS-Clean/JunkOS/Services/APIClient.swift"
      via: "createJob API call"
      pattern: "APIClient.shared.createJob"
    - from: "JunkOS-Clean/JunkOS/Services/APIClient.swift"
      to: "backend /api/jobs"
      via: "HTTP POST"
      pattern: "/api/jobs"
---

<objective>
Build the review and confirmation screen (final wizard step) showing a complete booking summary with expandable pricing, and wire the job creation API call. This is the last step before job creation (payment comes in Phase 3).

Purpose: The review screen lets the customer verify everything before committing. The Confirm Booking button creates the job in the backend with all collected data (service type, address, photos, schedule, calculated price). This completes the end-to-end booking flow for Phase 2.
Output: BookingReviewView.swift with full summary, BookingReviewViewModel.swift with job creation, updated APIClient with createJob and uploadPhotos methods, wired as step 4.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-pricing-booking/02-CONTEXT.md
@.planning/phases/02-pricing-booking/02-RESEARCH.md
@.planning/phases/02-pricing-booking/02-01-SUMMARY.md
@.planning/phases/02-pricing-booking/02-02-SUMMARY.md
@.planning/phases/02-pricing-booking/02-03-SUMMARY.md
@.planning/phases/02-pricing-booking/02-04-SUMMARY.md
@JunkOS-Clean/JunkOS/Services/APIClient.swift
@JunkOS-Clean/JunkOS/Models/BookingModels.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BookingReviewView with full summary and Confirm button</name>
  <files>JunkOS-Clean/JunkOS/Views/BookingReviewView.swift, JunkOS-Clean/JunkOS/ViewModels/BookingReviewViewModel.swift, JunkOS-Clean/JunkOS/Services/APIClient.swift</files>
  <action>
**Create BookingReviewView.swift** — the final step of the booking wizard.

Per user's locked decisions:
- Full summary card showing everything: service type, address(es), photo thumbnails, scheduled date/time, price with expandable breakdown
- Single "Confirm Booking" button at bottom
- This is the last step before job creation (payment comes in Phase 3)

Layout (ScrollView):

1. **Header**: "Review Your Booking" title, "Everything look good?" subtitle

2. **Service Summary Card** (UmuveCard):
   - Service type icon + name (e.g., truck.box.fill "Junk Removal")
   - If Junk Removal: volume tier (e.g., "1/2 Truck — Small room")
   - If Auto Transport: vehicle info (e.g., "2020 Toyota Camry") + surcharge badges ("Non-running", "Enclosed")

3. **Location Card** (UmuveCard):
   - "Pickup" section with mappin.circle.fill icon
   - Pickup address text (bookingData.address.fullAddress)
   - Mini-map preview (small, ~100pt height) centered on pickup coordinate
   - If Auto Transport: "Dropoff" section with dropoff address + mini-map + "Distance: X.X miles"

4. **Photos Card** (UmuveCard):
   - "Photos" section with camera.fill icon
   - Horizontal scroll of photo thumbnails (80x80pt, rounded corners)
   - Count text: "X photo(s) uploaded"
   - If no photos: "No photos added" with subtle warning text

5. **Schedule Card** (UmuveCard):
   - "Schedule" section with calendar icon
   - Date formatted nicely (e.g., "Saturday, Feb 15, 2026")
   - Time slot text (e.g., "8:00 AM - 10:00 AM")

6. **Price Section** (prominent, bottom of scroll):
   - Large total prominently displayed: "Est. $XXX.XX" in h1Font
   - Expandable detail section (tap "View breakdown"):
     - Base fee line
     - Distance fee line (if applicable)
     - Service multiplier line
     - Volume discount (if applicable)
     - Time surge (if applicable)
     - Divider
     - Total (bold)
   - "*Final price may be adjusted on-site" disclaimer in small text
   - Use DisclosureGroup or custom expandable with chevron animation

7. **Confirm Booking Button** (safeAreaInset bottom):
   - Text: "Confirm Booking"
   - Full-width, UmuvePrimaryButtonStyle
   - On tap: calls `viewModel.confirmBooking(bookingData:)`
   - Shows ProgressView when isSubmitting
   - Disabled while submitting

**Create BookingReviewViewModel.swift:**

ObservableObject:
- `@Published var isSubmitting = false`
- `@Published var showSuccess = false`
- `@Published var errorMessage: String?`
- `@Published var createdJobId: String?`

Methods:
- `@MainActor func confirmBooking(bookingData: BookingData) async`:
  1. Set isSubmitting = true
  2. Upload photos first: call `APIClient.shared.uploadPhotos(bookingData.photos)` → get photo URLs
  3. Create job: call `APIClient.shared.createJob(...)` with all booking data + photo URLs
  4. On success: set showSuccess = true, store createdJobId, haptic success
  5. On error: set errorMessage, haptic error, isSubmitting = false

**Add API methods to APIClient.swift:**

1. `func uploadPhotos(_ photos: [Data]) async throws -> [String]`:
   - Build multipart/form-data request
   - POST to `/api/upload/photos`
   - Include auth token (already handled by createRequest)
   - Field name: "files" (matches backend expectation)
   - Content-Type for each part: "image/jpeg"
   - Filename: "photo0.jpg", "photo1.jpg", etc.
   - Decode response: `{ "success": true, "urls": [...] }`
   - Return the urls array

2. `func createJob(serviceType: String, address: String, lat: Double, lng: Double, dropoffAddress: String?, dropoffLat: Double?, dropoffLng: Double?, photoUrls: [String], scheduledDate: String, scheduledTime: String, estimatedPrice: Double, volumeTier: String?, vehicleInfo: [String: String]?, distance: Double?) async throws -> JobCreationResponse`:
   - Build JSON body with all fields
   - POST to `/api/jobs` (or `/api/booking/create` — check what the backend expects)
   - Decode response to get job_id
   - Return response

3. Add `JobCreationResponse` struct:
   ```swift
   struct JobCreationResponse: Codable {
       let success: Bool
       let jobId: String?
       let message: String?

       enum CodingKeys: String, CodingKey {
           case success
           case jobId = "job_id"
           case message
       }
   }
   ```

Add new files to Xcode project (BookingReviewView.swift, BookingReviewViewModel.swift).
  </action>
  <verify>
Build the project. Verify:
1. BookingReviewView shows service summary, location, photos, schedule, price breakdown
2. Confirm button calls viewModel.confirmBooking
3. APIClient has uploadPhotos and createJob methods
4. Success/error states handled with alerts
  </verify>
  <done>
BookingReviewView shows complete summary (service, address, photos, schedule, expandable price). Confirm Booking button uploads photos then creates job via API. APIClient has uploadPhotos (multipart) and createJob methods. Success alert shows on job creation. Project compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire BookingReviewView as step 4 and finalize wizard flow</name>
  <files>JunkOS-Clean/JunkOS/Views/BookingWizardView.swift</files>
  <action>
**Update BookingWizardView.swift:**

1. Replace step 4 placeholder with `BookingReviewView().environmentObject(bookingData).environmentObject(wizardVM)`

2. Handle booking completion:
   - When `bookingData.bookingCompleted` changes to true (set by review view on success), dismiss the wizard and return to HomeView
   - Use `.onChange(of: bookingData.bookingCompleted)` to detect this
   - Reset bookingData and dismiss (pop navigation)

3. Final cleanup of wizard:
   - Ensure all 5 steps are now wired to real views (no more placeholder Text views)
   - Step 0: ServiceTypeSelectionView
   - Step 1: AddressInputView
   - Step 2: PhotoUploadView
   - Step 3: DateTimePickerView
   - Step 4: BookingReviewView

4. Add back navigation:
   - Toolbar back button that calls `wizardVM.goBack()` when currentStep > 0
   - On step 0, back button pops to HomeView (dismiss)
   - Back button label shows previous step name

5. Ensure the running price bar doesn't show on the review step (step 4 has its own price display).

6. Handle the success state after booking confirmation:
   - Show a success overlay or navigate to a simple "Booking Confirmed" screen
   - Display the job ID
   - "Done" button that resets bookingData and pops to HomeView
  </action>
  <verify>
Build the project. Full wizard flow:
1. Step 0: Service selection -> Continue
2. Step 1: Address entry -> Continue
3. Step 2: Photo upload -> Continue
4. Step 3: Schedule -> Continue
5. Step 4: Review -> Confirm Booking -> Success

Test that back button navigates to previous step. Test that tapping a completed step dot jumps to that step. Test that the wizard dismisses after booking success.
  </verify>
  <done>
All 5 wizard steps wired to real views. Back button navigates between steps. Completed step dots are tappable. Confirm Booking creates job via API. Success state dismisses wizard. Running price bar hides on review step. Complete booking flow functional end-to-end.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify complete booking flow on simulator</name>
  <what-built>Complete 5-step booking wizard: Service Selection (Junk Removal or Auto Transport with volume/vehicle options) -> Address Entry (MapKit autocomplete + mini-map) -> Photo Upload (gallery + camera, max 10) -> Schedule (date + time) -> Review & Confirm (full summary + expandable pricing + Confirm button that creates job in backend)</what-built>
  <how-to-verify>
1. Open Xcode project: JunkOS-Clean/JunkOS.xcodeproj
2. Build and run on iPhone 16 simulator
3. Sign in (or skip to main if already authenticated)
4. On HomeView, tap "Junk Removal" card
5. Verify: Wizard opens at Step 0 (Service Selection)
   - Two service cards visible (Junk Removal highlighted, Auto Transport available)
   - Truck fill selector shows 4 volume tiers
   - Select "1/2 Truck" and tap Continue
6. Verify: Step 1 (Address Entry)
   - Search field for address entry
   - Type an address — autocomplete suggestions should appear
   - Select a suggestion — mini-map preview should show
   - Tap Continue
7. Verify: Step 2 (Photo Upload)
   - Gallery and Camera buttons visible
   - Can proceed without photos (optional)
   - Tap Continue
8. Verify: Step 3 (Schedule)
   - Date cards in horizontal scroll
   - Time slots visible after date selection
   - Select date and time, tap Continue
9. Verify: Step 4 (Review)
   - Service type, address, photos, schedule, and price visible
   - Tap "View breakdown" to expand pricing detail
   - "Confirm Booking" button at bottom
10. Verify: Progress dots at top show completed steps in red, current step highlighted
11. Verify: Tapping a completed step dot jumps back to that step
12. Verify: Running price estimate bar visible during steps 1-3
13. Go back to HomeView and tap "Auto Transport" — verify vehicle info fields and dual address entry appear
  </how-to-verify>
  <resume-signal>Type "approved" if the complete flow works, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- BookingReviewView shows full summary: service type, address(es), photo thumbnails, date/time, expandable price breakdown
- Confirm Booking button uploads photos to backend, then creates job via API
- APIClient.uploadPhotos sends multipart form data to /api/upload/photos
- APIClient.createJob sends job data to backend and returns job_id
- All 5 wizard steps wired: ServiceTypeSelectionView, AddressInputView, PhotoUploadView, DateTimePickerView, BookingReviewView
- Back button and step dot navigation work
- Running price bar shows during steps 0-3, hidden on step 4
- Success state shows after job creation, dismisses wizard
- Project compiles: `xcodebuild build` succeeds
</verification>

<success_criteria>
Customer can complete the entire booking flow from service selection through job creation. Backend receives the job with all data (service type, address, photos, schedule, calculated price). The 5 success criteria from the roadmap are all met:
1. Customer can choose between Junk Removal and Auto Transport
2. Customer can upload photos that reach backend
3. Customer enters address via MapKit autocomplete with distance calculation
4. Customer sees price breakdown before booking
5. Backend creates job with calculated price after customer confirms
</success_criteria>

<output>
After completion, create `.planning/phases/02-pricing-booking/02-05-SUMMARY.md`
</output>
