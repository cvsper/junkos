---
phase: 02-pricing-booking
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - JunkOS-Clean/JunkOS/Views/AddressInputView.swift
  - JunkOS-Clean/JunkOS/ViewModels/AddressInputViewModel.swift
  - JunkOS-Clean/JunkOS/Views/BookingWizardView.swift
autonomous: true

must_haves:
  truths:
    - "Customer can type an address and see MapKit autocomplete suggestions"
    - "Customer selects a suggestion and sees a mini-map preview with pin"
    - "Junk Removal shows pickup address only"
    - "Auto Transport shows both pickup and dropoff address fields"
    - "Distance is calculated from pickup to dropoff coordinates using CLLocation"
    - "Address step plugs into BookingWizardView as step 1"
  artifacts:
    - path: "JunkOS-Clean/JunkOS/Views/AddressInputView.swift"
      provides: "Address entry with MapKit autocomplete and mini-map"
      contains: "MKLocalSearchCompleter"
    - path: "JunkOS-Clean/JunkOS/ViewModels/AddressInputViewModel.swift"
      provides: "Address search, geocoding, and distance calculation"
      contains: "AddressInputViewModel"
  key_links:
    - from: "JunkOS-Clean/JunkOS/Views/AddressInputView.swift"
      to: "JunkOS-Clean/JunkOS/ViewModels/AddressInputViewModel.swift"
      via: "@StateObject"
      pattern: "AddressInputViewModel"
    - from: "JunkOS-Clean/JunkOS/ViewModels/AddressInputViewModel.swift"
      to: "MapKit"
      via: "MKLocalSearchCompleter"
      pattern: "MKLocalSearchCompleter"
    - from: "JunkOS-Clean/JunkOS/Views/BookingWizardView.swift"
      to: "JunkOS-Clean/JunkOS/Views/AddressInputView.swift"
      via: "step 1 in wizard switch"
      pattern: "AddressInputView"
---

<objective>
Refactor the address input screen to use MapKit autocomplete with debounced search, mini-map preview, and conditional dropoff address for Auto Transport. Calculate distance between pickup and dropoff using CLLocation.

Purpose: Address entry provides the coordinates needed for pricing calculation (distance-based). Auto Transport requires both pickup and dropoff, while Junk Removal only needs pickup. MapKit autocomplete makes address entry fast and accurate.
Output: Refactored AddressInputView.swift with autocomplete + mini-map, refactored AddressInputViewModel.swift with search + distance, wired as step 1.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-pricing-booking/02-CONTEXT.md
@.planning/phases/02-pricing-booking/02-RESEARCH.md
@.planning/phases/02-pricing-booking/02-01-SUMMARY.md
@JunkOS-Clean/JunkOS/Views/AddressInputView.swift
@JunkOS-Clean/JunkOS/ViewModels/AddressInputViewModel.swift
@JunkOS-Clean/JunkOS/Models/BookingModels.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor AddressInputViewModel with MapKit autocomplete and distance calculation</name>
  <files>JunkOS-Clean/JunkOS/ViewModels/AddressInputViewModel.swift</files>
  <action>
Completely rewrite AddressInputViewModel.swift to add MapKit autocomplete with Combine debouncing.

**Class:** `AddressInputViewModel: NSObject, ObservableObject, MKLocalSearchCompleterDelegate`

**Published properties:**
- `@Published var pickupSearchQuery = ""` — text field binding for pickup
- `@Published var dropoffSearchQuery = ""` — text field binding for dropoff
- `@Published var pickupCompletions: [MKLocalSearchCompletion] = []` — autocomplete results for pickup
- `@Published var dropoffCompletions: [MKLocalSearchCompletion] = []` — autocomplete results for dropoff
- `@Published var isSearching = false` — loading indicator
- `@Published var pickupRegion: MKCoordinateRegion` — map region for pickup mini-map (default to US center)
- `@Published var dropoffRegion: MKCoordinateRegion` — map region for dropoff mini-map
- `@Published var pickupSelected = false` — true after user selects a pickup address from suggestions
- `@Published var dropoffSelected = false` — true after user selects a dropoff address from suggestions
- `@Published var calculatedDistance: Double?` — distance in miles between pickup and dropoff
- `@Published var locationError: String?` — error message

**Private properties:**
- Two `MKLocalSearchCompleter` instances (one for pickup, one for dropoff) — OR one shared completer that switches mode
- Simpler approach: Use ONE completer and a `searchMode: SearchMode` enum (`.pickup`, `.dropoff`) to track which field is active
- `private var cancellables = Set<AnyCancellable>()`

**Init:**
- Set up completer delegate (self), resultTypes = .address
- Debounce `$pickupSearchQuery` at 300ms → update completer.queryFragment
- Debounce `$dropoffSearchQuery` at 300ms → update completer.queryFragment
- Use `removeDuplicates()` to avoid redundant searches
- When query is empty, clear completions

**Delegate methods:**
- `completerDidUpdateResults(_ completer:)` — update pickupCompletions or dropoffCompletions based on searchMode. Dispatch to main queue.
- `completer(_:didFailWithError:)` — set locationError

**Public methods:**
- `func selectPickupAddress(_ completion: MKLocalSearchCompletion, bookingData: BookingData)` — performs MKLocalSearch to get coordinates, updates bookingData.address with street/city/state/zipCode, sets bookingData.pickupCoordinate, updates pickupRegion to center on selected address, sets pickupSelected = true, clears pickupCompletions
- `func selectDropoffAddress(_ completion: MKLocalSearchCompletion, bookingData: BookingData)` — same but for dropoff: updates bookingData.dropoffAddress, bookingData.dropoffCoordinate, dropoffRegion, dropoffSelected
- `func calculateDistance(bookingData: BookingData)` — uses CLLocation.distance(from:) to compute distance between pickupCoordinate and dropoffCoordinate. Converts meters to miles (/ 1609.34). Stores in bookingData.estimatedDistance and calculatedDistance.
- `func detectCurrentLocation(bookingData: BookingData)` — uses CLLocationManager to get current location, reverse geocode to address, set as pickup. Keep existing pattern.
- `func setSearchMode(_ mode: SearchMode)` — switches which field the completer is serving

**Important pitfall handling (from research):**
- Dispatch completer results to main queue
- Use `[weak self]` in all closures
- Handle empty query by clearing completions (don't send empty string to completer)

**SearchMode enum:**
```swift
enum SearchMode {
    case pickup
    case dropoff
}
```
  </action>
  <verify>
Build the project. AddressInputViewModel compiles with MKLocalSearchCompleter integration, debounced search, geocoding, and distance calculation.
  </verify>
  <done>
AddressInputViewModel uses MKLocalSearchCompleter with 300ms Combine debounce for autocomplete. selectPickupAddress and selectDropoffAddress geocode completions to coordinates. calculateDistance computes miles between coordinates. Project compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor AddressInputView with autocomplete UI, mini-map, and dropoff support</name>
  <files>JunkOS-Clean/JunkOS/Views/AddressInputView.swift, JunkOS-Clean/JunkOS/Views/BookingWizardView.swift</files>
  <action>
**Rewrite AddressInputView.swift** with MapKit autocomplete and conditional dropoff.

Per user's locked decisions:
- Junk Removal: pickup address only
- Auto Transport: pickup + dropoff addresses
- Show mini-map preview after address selection
- Address entry UX: text field with MapKit autocomplete (Claude's discretion)

Layout (ScrollView):

1. **Header**: "Where's the pickup?" title (or "Pickup & Dropoff" for auto transport)

2. **Pickup Address Section:**
   - Search field: TextField bound to `viewModel.pickupSearchQuery` with magnifyingglass icon and "Search address..." placeholder
   - Autocomplete suggestions list: Appears below the search field when `viewModel.pickupCompletions` is not empty
     - Each suggestion row: title + subtitle from MKLocalSearchCompletion
     - Tap a suggestion: calls `viewModel.selectPickupAddress(completion, bookingData: bookingData)`
     - List styled: white background, dividers between items, max 5 visible
   - Mini-map preview: Appears when `viewModel.pickupSelected` is true
     - Map view (MKMapView via Map SwiftUI) centered on pickup coordinate, 150pt height
     - Pin annotation at pickup location
     - Address text below map: `bookingData.address.fullAddress`
     - "Change" button to re-enter (resets pickupSelected, clears search query)
   - "Use Current Location" button with location.fill icon (existing pattern from old view)

3. **Dropoff Address Section** (only if `bookingData.needsDropoff`):
   - Same pattern as pickup: search field, autocomplete suggestions, mini-map preview
   - Uses viewModel.dropoffSearchQuery, viewModel.dropoffCompletions
   - On selection: calls viewModel.selectDropoffAddress
   - After both addresses selected: show distance calculation "Distance: X.X miles" with car.fill icon

4. **Continue Button** (safeAreaInset bottom):
   - Enabled when: pickup is selected AND (if auto transport: dropoff is also selected)
   - On tap: if auto transport, call `viewModel.calculateDistance(bookingData:)` first, then `wizardVM.completeCurrentStep()`
   - Use `UmuvePrimaryButtonStyle`

**Wire into BookingWizardView.swift:**
- Replace step 1 placeholder with `AddressInputView().environmentObject(bookingData).environmentObject(wizardVM)`

Remove old address form fields (street, unit, city, zip manual entry) — replaced entirely by autocomplete search.

Keep `InputField` component — may still be useful for other views, but AddressInputView no longer uses it for address entry.

Use design system: `Color.umuveBackground`, `Color.umuvePrimary`, `UmuveTypography`, `UmuveSpacing`, `UmuveCard`.
  </action>
  <verify>
Build the project. Verify:
1. AddressInputView has search field with autocomplete suggestion list
2. Selecting a suggestion shows mini-map preview with pin
3. Auto Transport shows both pickup and dropoff sections
4. Junk Removal shows only pickup section
5. Continue button enables after required addresses are selected
6. AddressInputView is wired as step 1 in BookingWizardView
  </verify>
  <done>
AddressInputView has MapKit autocomplete search for pickup (and dropoff for Auto Transport), mini-map preview after selection, distance calculation for two-address bookings. Wired as step 1 in wizard. Project compiles.
  </done>
</task>

</tasks>

<verification>
- AddressInputView has MapKit autocomplete with debounced search (300ms)
- Autocomplete suggestions appear as user types
- Selecting a suggestion geocodes to coordinates and shows mini-map
- Junk Removal: pickup address only
- Auto Transport: pickup + dropoff addresses with distance calculation
- Mini-map shows pin at selected location
- Project compiles: `xcodebuild build` succeeds
</verification>

<success_criteria>
Customer can enter addresses via MapKit autocomplete, see mini-map previews, and Auto Transport users see both pickup and dropoff with calculated distance.
</success_criteria>

<output>
After completion, create `.planning/phases/02-pricing-booking/02-03-SUMMARY.md`
</output>
