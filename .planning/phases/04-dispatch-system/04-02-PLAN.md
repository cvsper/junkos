---
phase: 04-dispatch-system
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - JunkOS-Driver/Services/SocketIOManager.swift
  - JunkOS-Driver/ViewModels/JobFeedViewModel.swift
  - JunkOS-Driver/Views/Jobs/JobFeedView.swift
autonomous: true

must_haves:
  truths:
    - "When another driver accepts a job, it disappears from this driver's job feed in real-time"
    - "Driver can accept a job from the in-app job feed (JobDetailView Accept button)"
    - "Driver can accept a job from the live map job alert overlay (Socket.IO job:new event)"
    - "When driver taps a push notification for a new job, the app navigates to the Jobs tab"
    - "Job feed refreshes on pull-to-refresh and on tab appearance"
  artifacts:
    - path: "JunkOS-Driver/Services/SocketIOManager.swift"
      provides: "job:accepted listener that posts NotificationCenter event for feed removal"
      contains: "job:accepted"
    - path: "JunkOS-Driver/ViewModels/JobFeedViewModel.swift"
      provides: "Real-time job removal when job:accepted event received"
      contains: "removeJob"
    - path: "JunkOS-Driver/Views/Jobs/JobFeedView.swift"
      provides: "Notification observer that triggers job removal from feed"
      contains: "jobWasAccepted"
  key_links:
    - from: "JunkOS-Driver/Services/SocketIOManager.swift"
      to: "JunkOS-Driver/ViewModels/JobFeedViewModel.swift"
      via: "NotificationCenter post on job:accepted -> observer removes job from array"
      pattern: "jobWasAccepted"
    - from: "JunkOS-Driver/Views/Jobs/JobFeedView.swift"
      to: "JunkOS-Driver/ViewModels/JobFeedViewModel.swift"
      via: "onReceive publisher calls removeJob"
      pattern: "removeJob"
---

<objective>
Wire the driver app's job feed to respond to real-time Socket.IO events so that accepted jobs are immediately removed from the feed, and new jobs appear without manual refresh.

Purpose: The driver app has all the UI components (JobFeedView, JobAlertOverlay, JobDetailView with Accept button) but the SocketIOManager doesn't listen for `job:accepted` events, so other drivers' feeds don't update when a job is claimed. This creates a poor experience where drivers tap "Accept" only to get a 409 error.

Output: Three updated Swift files completing the real-time dispatch loop on the driver side.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-dispatch-system/04-01-SUMMARY.md
@JunkOS-Driver/Services/SocketIOManager.swift
@JunkOS-Driver/ViewModels/JobFeedViewModel.swift
@JunkOS-Driver/Views/Jobs/JobFeedView.swift
@JunkOS-Driver/ViewModels/LiveMapViewModel.swift
@JunkOS-Driver/Views/Map/LiveMapView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add job:accepted listener to SocketIOManager and wire feed removal</name>
  <files>
    JunkOS-Driver/Services/SocketIOManager.swift
    JunkOS-Driver/ViewModels/JobFeedViewModel.swift
    JunkOS-Driver/Views/Jobs/JobFeedView.swift
  </files>
  <action>
**IMPORTANT**: Use ObservableObject pattern where appropriate for iOS 16 compatibility per project conventions. However, note that the driver app currently uses @Observable (Observation framework) throughout — follow the existing pattern in the driver app (it uses @Observable, not ObservableObject).

**1. SocketIOManager.swift — Add `job:accepted` listener:**

In the `connect(token:)` method, after the existing `socket?.on("job:assigned")` block, add a listener for `job:accepted`:

```swift
// Listen for job acceptance by other drivers (remove from feed)
socket?.on("job:accepted") { [weak self] data, _ in
    guard let dict = data.first as? [String: Any],
          let jobId = dict["job_id"] as? String else { return }
    DispatchQueue.main.async {
        NotificationCenter.default.post(
            name: .jobWasAccepted,
            object: nil,
            userInfo: ["job_id": jobId]
        )
    }
}
```

Also add a listener for `job:new` that posts to NotificationCenter so the feed can add new jobs:

```swift
// Also post job:new to NotificationCenter for the feed (supplement existing newJobAlert)
socket?.on("job:new") { data, _ in
    guard let dict = data.first as? [String: Any],
          let jsonData = try? JSONSerialization.data(withJSONObject: dict),
          let job = try? JSONDecoder().decode(DriverJob.self, from: jsonData) else { return }
    DispatchQueue.main.async {
        NotificationCenter.default.post(
            name: .newJobAvailable,
            object: nil,
            userInfo: ["job": job]
        )
    }
}
```

Wait — the existing `job:new` handler already sets `self?.newJobAlert = job`. Don't duplicate it. Instead, just add the NotificationCenter post at the end of the EXISTING `job:new` handler (after setting newJobAlert). This way both the LiveMapView (via newJobAlert property) and JobFeedView (via NotificationCenter) get notified.

Add the Notification.Name extensions. Check if there's already a file with Notification.Name extensions — the driver NotificationManager.swift already has `.didTapPushNotification`. Add the new names in the same file or in SocketIOManager.swift:

```swift
extension Notification.Name {
    static let jobWasAccepted = Notification.Name("jobWasAccepted")
    static let newJobAvailable = Notification.Name("newJobAvailable")
}
```

Place these in SocketIOManager.swift above the class definition (next to any existing extensions, or add them fresh). Note: `.didTapPushNotification` is already defined in NotificationManager.swift — don't duplicate it.

**2. JobFeedViewModel.swift — Add removeJob and addJob methods:**

Add two methods:

```swift
func removeJob(id: String) {
    jobs.removeAll { $0.id == id }
}

func addJobIfNew(_ job: DriverJob) {
    guard !jobs.contains(where: { $0.id == job.id }) else { return }
    jobs.insert(job, at: 0)
}
```

**3. JobFeedView.swift — Observe NotificationCenter for real-time updates:**

Add `.onReceive` modifiers to the view body for both notifications:

```swift
.onReceive(NotificationCenter.default.publisher(for: .jobWasAccepted)) { notification in
    if let jobId = notification.userInfo?["job_id"] as? String {
        withAnimation(.easeOut(duration: 0.3)) {
            viewModel.removeJob(id: jobId)
        }
    }
}
.onReceive(NotificationCenter.default.publisher(for: .newJobAvailable)) { notification in
    if let job = notification.userInfo?["job"] as? DriverJob {
        withAnimation(.spring(response: 0.4)) {
            viewModel.addJobIfNew(job)
        }
    }
}
```

Place these modifiers on the outer NavigationStack. Also, after a successful job acceptance from JobDetailView (which pops back to the feed), the feed should auto-refresh. The existing `.task` modifier already calls `loadJobs()` on appearance, which handles this.

Also handle the 409 error gracefully in JobDetailViewModel — when `acceptJob` gets a 409 response, the error message should say "This job was already accepted by another driver" and the job should be removed from the feed. The existing error handling in JobDetailViewModel already displays the server error message (which already returns "Job cannot be accepted (current status: ...)"). This is sufficient.
  </action>
  <verify>
1. Read SocketIOManager.swift — verify `job:accepted` listener posts to NotificationCenter
2. Read SocketIOManager.swift — verify `job:new` handler also posts to NotificationCenter
3. Read JobFeedViewModel.swift — verify `removeJob(id:)` and `addJobIfNew(_:)` methods exist
4. Read JobFeedView.swift — verify `.onReceive` for both `.jobWasAccepted` and `.newJobAvailable`
5. Verify Notification.Name extensions are defined (`.jobWasAccepted`, `.newJobAvailable`)
6. Build check: `xcodebuild -project JunkOS-Driver/JunkOS-Driver.xcodeproj -scheme JunkOS-Driver -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5` (check for compile errors)
  </verify>
  <done>Accepted jobs disappear from the feed in real-time via Socket.IO events, new jobs appear in the feed without manual refresh, and the SocketIOManager bridges Socket.IO events to NotificationCenter for UI updates</done>
</task>

</tasks>

<verification>
1. SocketIOManager listens for `job:accepted` and `job:new` events
2. Job feed removes accepted jobs via NotificationCenter observer
3. Job feed adds new jobs via NotificationCenter observer
4. Push notification tap navigates to Jobs tab (already working via DriverTabView.onReceive)
5. LiveMapView job alert overlay still works (newJobAlert property unchanged)
</verification>

<success_criteria>
- `job:accepted` Socket.IO event triggers removal from JobFeedView
- `job:new` Socket.IO event triggers insertion into JobFeedView
- Both updates animate smoothly (withAnimation)
- No compilation errors in Xcode
- Existing job alert overlay on LiveMapView still works
</success_criteria>

<output>
After completion, create `.planning/phases/04-dispatch-system/04-02-SUMMARY.md`
</output>
