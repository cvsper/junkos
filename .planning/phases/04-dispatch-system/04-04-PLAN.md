---
phase: 04-dispatch-system
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Drivers with availability toggled online receive push notifications for new jobs in their area"
    - "Driver can accept a job from notification or in-app feed (first-come-first-serve)"
    - "Once a job is accepted, it disappears from other drivers' feeds"
    - "Customer receives push notification when their job is assigned to a driver"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete dispatch system end-to-end against the four phase success criteria.

Purpose: Confirm all four DISP requirements are met before marking Phase 4 complete.

Output: Verification results confirming phase completion.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-dispatch-system/04-01-SUMMARY.md
@.planning/phases/04-dispatch-system/04-02-SUMMARY.md
@.planning/phases/04-dispatch-system/04-03-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify dispatch system end-to-end</name>
  <files>backend/routes/booking.py, backend/routes/drivers.py, backend/socket_events.py, JunkOS-Driver/Services/SocketIOManager.swift, JunkOS-Driver/ViewModels/JobFeedViewModel.swift, JunkOS-Driver/Views/Jobs/JobFeedView.swift, JunkOS-Clean/JunkOS/Managers/NotificationManager.swift, JunkOS-Clean/JunkOS/Views/OrdersView.swift</files>
  <action>
Verify the complete dispatch system built across plans 01-03. This is a human verification checkpoint — read all files listed and confirm the wiring is correct:

1. DISP-01: booking.py _notify_nearby_contractors calls send_push_notification AND notify_nearby_drivers
2. DISP-02: drivers.py accept_job validates status before assignment, JobDetailView has Accept button, JobAlertOverlay has Accept button
3. DISP-03: socket_events.py broadcast_job_accepted emits to all driver rooms, SocketIOManager listens for job:accepted, JobFeedViewModel has removeJob, JobFeedView has onReceive for jobWasAccepted
4. DISP-04: drivers.py accept_job calls send_push_notification to customer, customer NotificationManager has driverAssigned category, OrdersView shows Driver Assigned badge
  </action>
  <verify>Both Xcode projects compile without errors. All four DISP requirements have corresponding code paths.</verify>
  <done>All four phase success criteria verified: drivers receive push for new jobs, drivers accept from feed or alert, accepted jobs removed from other feeds, customer notified on assignment</done>
  <what-built>
Complete dispatch system:
- Backend sends APNs push + Socket.IO to nearby drivers when job is created
- Backend sends APNs push to customer when driver accepts job
- Backend broadcasts job removal to all online drivers via Socket.IO on acceptance
- Driver app removes accepted jobs from feed in real-time
- Driver app adds new jobs to feed in real-time
- Customer app shows "Driver Assigned" status and handles push notifications
- Race condition prevention via database transaction status validation
  </what-built>
  <how-to-verify>
1. DISP-01 (Driver push notifications):
   - Open backend/routes/booking.py — confirm _notify_nearby_contractors calls send_push_notification AND notify_nearby_drivers
   - Open JunkOS-Driver/Managers/NotificationManager.swift — confirm push permission request and device token registration

2. DISP-02 (Driver accepts job):
   - Open backend/routes/drivers.py — confirm accept_job validates status before assignment
   - Open JunkOS-Driver/Views/Jobs/JobDetailView.swift — confirm Accept button calls viewModel.acceptJob
   - Open JunkOS-Driver/Views/Map/JobAlertOverlay.swift — confirm Accept button on map overlay

3. DISP-03 (Job removed from feed):
   - Open backend/socket_events.py — confirm broadcast_job_accepted emits to all driver rooms
   - Open JunkOS-Driver/Services/SocketIOManager.swift — confirm job:accepted listener
   - Open JunkOS-Driver/ViewModels/JobFeedViewModel.swift — confirm removeJob method
   - Open JunkOS-Driver/Views/Jobs/JobFeedView.swift — confirm .onReceive for jobWasAccepted

4. DISP-04 (Customer notification):
   - Open backend/routes/drivers.py — confirm accept_job calls send_push_notification to customer
   - Open JunkOS-Clean/JunkOS/Managers/NotificationManager.swift — confirm driverAssigned category
   - Open JunkOS-Clean/JunkOS/Views/OrdersView.swift — confirm Driver Assigned status badge

Build verification:
- Both Xcode projects should compile without errors
  </how-to-verify>
  <resume-signal>Type "approved" if all dispatch requirements are verified, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 4 success criteria from ROADMAP.md:
1. Drivers with availability toggled "online" receive push notifications for new jobs in their area
2. Driver can accept a job from notification or in-app feed (first-come-first-serve)
3. Once a job is accepted, it disappears from other drivers' feeds
4. Customer receives push notification when their job is assigned to a driver
</verification>

<success_criteria>
All four DISP requirements verified and passing.
</success_criteria>

<output>
After completion, create `.planning/phases/04-dispatch-system/04-04-SUMMARY.md`
</output>
