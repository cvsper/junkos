---
phase: 01-foundation-authentication
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - JunkOS-Clean/JunkOS/Components/Onboarding/OnboardingView.swift
  - JunkOS-Clean/JunkOS/Views/Auth/WelcomeAuthView.swift
  - JunkOS-Clean/JunkOS/JunkOSApp.swift
  - JunkOS-Clean/JunkOS/Views/EnhancedWelcomeView.swift
  - JunkOS-Clean/JunkOS/Views/ProfileView.swift
autonomous: true

must_haves:
  truths:
    - "Customer app shows 3 onboarding screens on first launch before sign-in"
    - "Customer sign-in screen shows only Apple Sign In button, no other options"
    - "No guest browsing — user must sign in before accessing any app functionality"
    - "Sign-out button available in Profile/Settings screen"
    - "Offline launch shows cached state with offline banner"
    - "Error message displays inline below sign-in button on failure"
  artifacts:
    - path: "JunkOS-Clean/JunkOS/Components/Onboarding/OnboardingView.swift"
      provides: "3-screen customer onboarding with PageTabViewStyle"
      contains: "PageTabViewStyle"
    - path: "JunkOS-Clean/JunkOS/Views/Auth/WelcomeAuthView.swift"
      provides: "Apple Sign In only screen with Umuve branding"
      contains: "SignInWithAppleButton"
    - path: "JunkOS-Clean/JunkOS/JunkOSApp.swift"
      provides: "App entry point routing: Splash -> Onboarding -> Sign In -> Main"
      contains: "hasCompletedOnboarding"
  key_links:
    - from: "JunkOS-Clean/JunkOS/JunkOSApp.swift"
      to: "JunkOS-Clean/JunkOS/Components/Onboarding/OnboardingView.swift"
      via: "First launch routing"
      pattern: "OnboardingView|hasCompletedOnboarding"
    - from: "JunkOS-Clean/JunkOS/JunkOSApp.swift"
      to: "JunkOS-Clean/JunkOS/Views/Auth/WelcomeAuthView.swift"
      via: "Auth gate after onboarding"
      pattern: "isAuthenticated.*WelcomeAuthView"
    - from: "JunkOS-Clean/JunkOS/Views/Auth/WelcomeAuthView.swift"
      to: "JunkOS-Clean/JunkOS/Managers/AuthenticationManager.swift"
      via: "Apple Sign In calls"
      pattern: "handleAppleSignIn"
---

<objective>
Customer app onboarding and sign-in UI: Replace existing multi-option auth with Apple Sign In only, add 3-screen onboarding flow, rewire app entry point.

Purpose: Complete the customer-facing auth experience per user decisions. Users see onboarding on first launch, then Apple Sign In as the only option. No guest mode, no phone/email auth.

Output: Rewritten OnboardingView (3 screens matching customer journey), Apple-only WelcomeAuthView, updated JunkOSApp entry point, sign-out in profile.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md

# Existing files to reference
@JunkOS-Clean/JunkOS/JunkOSApp.swift
@JunkOS-Clean/JunkOS/Components/Onboarding/OnboardingView.swift
@JunkOS-Clean/JunkOS/Views/Auth/WelcomeAuthView.swift
@JunkOS-Clean/JunkOS/Views/EnhancedWelcomeView.swift
@JunkOS-Clean/JunkOS/Views/ProfileView.swift
@JunkOS-Clean/JunkOS/Managers/AuthenticationManager.swift
@JunkOS-Clean/JunkOS/Design/DesignSystem.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite customer onboarding and Apple-only sign-in screen</name>
  <files>
    JunkOS-Clean/JunkOS/Components/Onboarding/OnboardingView.swift
    JunkOS-Clean/JunkOS/Views/Auth/WelcomeAuthView.swift
  </files>
  <action>
**OnboardingView.swift** — Complete rewrite. 3-screen swipeable onboarding for customer app, shown on first launch only.

Per user decisions — customer onboarding highlights the core flow:
- Screen 1: "Book a pickup" — SF Symbol `shippingbox` or `cube.box`, brief text: "Tell us what you need hauled and we'll handle the rest."
- Screen 2: "Track your driver" — SF Symbol `location.fill` or `map`, brief text: "Watch your driver arrive in real time on the map."
- Screen 3: "Done — hauling made simple" — SF Symbol `checkmark.circle` or `hand.thumbsup`, brief text: "Sit back while we haul it all away. That's it."

Implementation:
- Use `TabView` with `PageTabViewStyle(indexDisplayMode: .always)` — native iOS swipeable with dots at bottom
- `@AppStorage("hasCompletedOnboarding")` persists first-launch state (reuse existing key name)
- Each page: large SF Symbol icon centered in a circle with `umuvePrimary` gradient background, title below, subtitle below that
- Use customer design system: `UmuveTypography`, `UmuveSpacing`, `Color.umuvePrimary`, `Color.umuveBackground`
- Clean white background — NOT the red gradient
- "Next" button for screens 1-2, "Get Started" button on screen 3
- "Skip" text button in top-right corner
- Respect `@Environment(\.accessibilityReduceMotion)` — skip entrance animations if enabled
- On completion, set `hasCompletedOnboarding = true`
- Remove the `OnboardingManager` class (just use `@AppStorage` directly)
- Remove the `PermissionPrePromptView` — not part of this phase

**WelcomeAuthView.swift** — Complete rewrite. Apple Sign In only screen.

Per user decisions: Umuve logo/wordmark at top, "Sign in with Apple" button centered, clean white background with red accent. No "Create an account", no "Continue as Guest", no "Log In" link.

Implementation:
- Remove ALL state variables for `showPhoneSignUp`, `showLogin`
- Remove ALL `fullScreenCover` for PhoneSignUpView, LoginOptionsView
- Clean `Color.umuveBackground` background (light, not gradient)
- Top section: Umuve logo (SF Symbol `trash.circle.fill` or app icon) + "Umuve" wordmark + "Hauling made simple." tagline
- Center/bottom section: `SignInWithAppleButton(.signIn)` from AuthenticationServices
  - Style: `.black` for the Apple button
  - Frame height: 52pt
  - Clip to rounded rectangle with `UmuveRadius.md`
  - Call `authManager.handleAppleSignInRequest(request)` and `authManager.handleAppleSignInCompletion(result)`
- Error display: if `authManager.errorMessage` is non-nil, show text below the Apple button in `Color.umuveError` with `UmuveTypography.bodySmallFont`. Text content comes from authManager (e.g., "Something went wrong. Try again.")
- Loading state: if `authManager.isLoading`, overlay a `ProgressView()` on the button area
- NOTE: The AuthenticationManager was rewritten in Plan 01 to use `@Observable`. Update this view accordingly:
  - Change from `@EnvironmentObject var authManager: AuthenticationManager` to receiving it via `@Environment` or passed as a binding from the parent. Since Plan 01 changed AuthenticationManager to `@Observable`, use `@Bindable var authManager: AuthenticationManager` or simply reference it from the environment. Match the pattern used in JunkOSApp.swift after Plan 01's changes.
  - If Plan 01 made AuthenticationManager `@Observable`, the parent (JunkOSApp) will need to pass it via `.environment()` or as a parameter. Use whichever pattern Plan 01 established.
- Import `AuthenticationServices` for `SignInWithAppleButton`
  </action>
  <verify>
Build: `xcodebuild build -project JunkOS-Clean/JunkOS-Clean.xcodeproj -scheme JunkOS -destination 'platform=iOS Simulator,name=iPhone 16' -quiet 2>&1 | tail -5`. Should compile without errors.
Grep Apple button: `grep -c "SignInWithAppleButton" JunkOS-Clean/JunkOS/Views/Auth/WelcomeAuthView.swift` should return > 0.
Grep no guest: `grep -c "continueAsGuest\|Continue as Guest" JunkOS-Clean/JunkOS/Views/Auth/WelcomeAuthView.swift` should return 0.
Grep no phone: `grep -c "PhoneSignUp\|showPhoneSignUp" JunkOS-Clean/JunkOS/Views/Auth/WelcomeAuthView.swift` should return 0.
File has PageTabView: `grep -c "PageTabViewStyle" JunkOS-Clean/JunkOS/Components/Onboarding/OnboardingView.swift` should return > 0.
  </verify>
  <done>
Customer onboarding with 3 screens (Book a pickup, Track your driver, Done) using PageTabViewStyle, shown on first launch only. WelcomeAuthView shows only Umuve logo + "Sign in with Apple" button. No guest mode, no phone signup, no email login. Error message displays inline. Loading state shown on button.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewire app entry point and add sign-out to profile</name>
  <files>
    JunkOS-Clean/JunkOS/JunkOSApp.swift
    JunkOS-Clean/JunkOS/Views/EnhancedWelcomeView.swift
    JunkOS-Clean/JunkOS/Views/ProfileView.swift
  </files>
  <action>
**JunkOSApp.swift** — Rewrite the app entry point routing:

Per user decisions: onboarding on first launch only -> auth wall (must sign in) -> main app. No guest browsing.

1. **Update AuthenticationManager usage:** Plan 01 changed AuthenticationManager to `@Observable`. Update from `@StateObject private var authManager = AuthenticationManager()` to `@State private var authManager = AuthenticationManager()`. Remove `@EnvironmentObject` passing — use `.environment(authManager)` instead (Swift Observation pattern).

2. **Update routing logic in body:**
```swift
Group {
    if !hasCompletedOnboarding {
        OnboardingView()
    } else if !authManager.isAuthenticated {
        WelcomeAuthView(authManager: authManager)
    } else {
        MainTabView()
            .onAppear {
                notificationManager.requestPermission()
                Task { await authManager.refreshTokenIfNeeded() }
            }
    }
}
```

Key changes:
- Remove `showingSplash` state and `EnhancedWelcomeView` entirely — the onboarding IS the first-launch experience
- Use `@AppStorage("hasCompletedOnboarding")` to check first launch
- Auth wall: if not authenticated, show WelcomeAuthView (no guest bypass)
- After auth, go straight to MainTabView (no post-auth profile setup per user decisions)
- On MainTabView appear, trigger token refresh check
- Pass `authManager` to child views via `.environment()` or direct parameter (match @Observable pattern)

3. **Add offline detection:**
- Use `NWPathMonitor` from `Network` framework to monitor connectivity
- `@State private var isOffline = false`
- When offline on launch with valid Keychain token, show MainTabView with an overlay banner: "You're offline" (subtle bar at top, auto-retry in background)
- Start NWPathMonitor in `.onAppear`, update `isOffline` on path changes
- Pass `isOffline` to MainTabView or use `.overlay()` on MainTabView

**EnhancedWelcomeView.swift** — This file is no longer used (replaced by OnboardingView). Either delete its contents and leave a comment, or leave it as-is since it won't be referenced. Do NOT delete the file (Xcode project references would break) — instead, add a comment at top: `// DEPRECATED: Replaced by OnboardingView.swift in Phase 1`. If the Xcode project's compile sources still include it, it must still compile, so just leave the existing code but make sure JunkOSApp no longer references it.

**ProfileView.swift** — Add sign-out button:

Per user decisions: sign-out button in Settings/Profile screen.

- Read the existing ProfileView.swift
- Add a "Sign Out" button at the bottom of the profile view
- Style: `DriverDestructiveButtonStyle` equivalent for customer (red text on light red background) OR use `UmuveSecondaryButtonStyle` with red text
- On tap: call `authManager.logout()` — this clears Keychain and resets isAuthenticated, which automatically routes back to WelcomeAuthView
- Add a confirmation alert before signing out: "Are you sure you want to sign out?" with "Sign Out" (destructive) and "Cancel" buttons
- Access authManager via `@Environment(AuthenticationManager.self)` or however it's passed in the updated pattern
  </action>
  <verify>
Build: `xcodebuild build -project JunkOS-Clean/JunkOS-Clean.xcodeproj -scheme JunkOS -destination 'platform=iOS Simulator,name=iPhone 16' -quiet 2>&1 | tail -5`. Should compile without errors.
Grep onboarding routing: `grep -c "hasCompletedOnboarding" JunkOS-Clean/JunkOS/JunkOSApp.swift` should return > 0.
Grep no splash: `grep -c "EnhancedWelcomeView\|showingSplash" JunkOS-Clean/JunkOS/JunkOSApp.swift` should return 0.
Grep no guest: `grep -c "continueAsGuest" JunkOS-Clean/JunkOS/JunkOSApp.swift` should return 0.
Grep sign out: `grep -c "Sign Out\|logout" JunkOS-Clean/JunkOS/Views/ProfileView.swift` should return > 0.
  </verify>
  <done>
App entry point routes: Onboarding (first launch) -> Apple Sign In (auth wall, no guest) -> MainTabView. Offline detection shows banner overlay on MainTabView. EnhancedWelcomeView deprecated (no longer referenced). ProfileView has Sign Out button with confirmation alert. Token refresh triggered on app launch.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild build -project JunkOS-Clean/JunkOS-Clean.xcodeproj -scheme JunkOS -destination 'platform=iOS Simulator,name=iPhone 16' -quiet` succeeds
2. `grep "hasCompletedOnboarding" JunkOS-Clean/JunkOS/JunkOSApp.swift` returns matches
3. `grep "SignInWithAppleButton" JunkOS-Clean/JunkOS/Views/Auth/WelcomeAuthView.swift` returns matches
4. `grep -c "continueAsGuest\|PhoneSignUp\|EmailLogin\|showLogin\|showPhoneSignUp" JunkOS-Clean/JunkOS/Views/Auth/WelcomeAuthView.swift` returns 0
5. `grep "logout" JunkOS-Clean/JunkOS/Views/ProfileView.swift` returns matches
6. `grep -c "EnhancedWelcomeView" JunkOS-Clean/JunkOS/JunkOSApp.swift` returns 0
7. `grep "PageTabViewStyle" JunkOS-Clean/JunkOS/Components/Onboarding/OnboardingView.swift` returns matches
</verification>

<success_criteria>
- First launch shows 3 onboarding screens before sign-in
- Sign-in screen has only Apple Sign In button — no guest, phone, or email options
- User must authenticate before seeing any app content
- Sign-out available in Profile view with confirmation
- Offline launch shows cached main view with offline banner
- App routing: Onboarding (once) -> Sign In -> Main
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md`
</output>
