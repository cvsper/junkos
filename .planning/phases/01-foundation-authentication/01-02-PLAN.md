---
phase: 01-foundation-authentication
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - JunkOS-Driver/Managers/AuthenticationManager.swift
  - JunkOS-Driver/Services/DriverAPIClient.swift
  - JunkOS-Driver/Models/AuthModels.swift
  - JunkOS-Driver/Views/Auth/DriverAuthView.swift
  - JunkOS-Driver/Views/Auth/DriverOnboardingView.swift
  - JunkOS-Driver/JunkOSDriverApp.swift
autonomous: true

must_haves:
  truths:
    - "Driver app sends identity_token and nonce with Apple Sign In to backend"
    - "Driver app shows 3 onboarding screens on first launch before sign-in"
    - "Driver sign-in screen shows only Apple Sign In button, no email/password options"
    - "Driver remains authenticated across app restarts via Keychain"
    - "Token refresh happens silently when near expiry"
  artifacts:
    - path: "JunkOS-Driver/Managers/AuthenticationManager.swift"
      provides: "Apple Sign In with nonce generation"
      contains: "CryptoKit"
    - path: "JunkOS-Driver/Views/Auth/DriverOnboardingView.swift"
      provides: "3-screen onboarding flow for first launch"
      contains: "PageTabViewStyle"
    - path: "JunkOS-Driver/Views/Auth/DriverAuthView.swift"
      provides: "Apple Sign In only screen"
      contains: "SignInWithAppleButton"
  key_links:
    - from: "JunkOS-Driver/Managers/AuthenticationManager.swift"
      to: "JunkOS-Driver/Utilities/KeychainHelper.swift"
      via: "Keychain save/load for JWT"
      pattern: "KeychainHelper\\.save|KeychainHelper\\.loadString"
    - from: "JunkOS-Driver/JunkOSDriverApp.swift"
      to: "JunkOS-Driver/Views/Auth/DriverOnboardingView.swift"
      via: "First launch detection and onboarding display"
      pattern: "hasCompletedOnboarding|DriverOnboardingView"
    - from: "JunkOS-Driver/Managers/AuthenticationManager.swift"
      to: "JunkOS-Driver/Services/DriverAPIClient.swift"
      via: "Apple Sign In with identity_token"
      pattern: "identity_token.*nonce"
---

<objective>
Driver app auth hardening and onboarding: Add nonce to Apple Sign In, simplify auth screen to Apple-only, add 3-screen onboarding, token refresh.

Purpose: AUTH-02 driver side (Apple Sign In with nonce validation) plus user-facing onboarding screens per user decisions. The driver app already uses Keychain (no migration needed), but needs nonce handling, simplified UI, and onboarding.

Output: Updated AuthenticationManager with nonce, new DriverOnboardingView (3 screens), simplified DriverAuthView (Apple Sign In only), updated app entry point with onboarding flow.
</objective>

<execution_context>
@/Users/sevs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sevs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md

# Existing files to reference
@JunkOS-Driver/Managers/AuthenticationManager.swift
@JunkOS-Driver/Services/DriverAPIClient.swift
@JunkOS-Driver/Models/AuthModels.swift
@JunkOS-Driver/Views/Auth/DriverAuthView.swift
@JunkOS-Driver/Views/Splash/SplashView.swift
@JunkOS-Driver/JunkOSDriverApp.swift
@JunkOS-Driver/Utilities/KeychainHelper.swift
@JunkOS-Driver/Design/DriverDesignSystem.swift
@JunkOS-Driver/ViewModels/AppState.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add nonce to driver Apple Sign In and token refresh</name>
  <files>
    JunkOS-Driver/Managers/AuthenticationManager.swift
    JunkOS-Driver/Services/DriverAPIClient.swift
    JunkOS-Driver/Models/AuthModels.swift
  </files>
  <action>
**AuthenticationManager.swift** — Update the existing `@Observable` AuthenticationManager:

1. **Add nonce generation** (import `CryptoKit`):
   - Private property: `private var currentNonce: String?`
   - Private method: `generateNonce(length: Int = 32) -> String` — Generate random bytes using `SecRandomCopyBytes`, convert to hex string
   - Private method: `sha256(_ input: String) -> String` — SHA256 hash using `CryptoKit.SHA256`, return hex string

2. **Update `handleAppleSignInRequest`:**
   - Generate nonce via `generateNonce()`
   - Store raw nonce in `currentNonce`
   - Set `request.nonce = sha256(nonce)` (hashed nonce goes to Apple)
   - Keep existing `request.requestedScopes = [.fullName, .email]`

3. **Update `handleAppleSignInCompletion`:**
   - After extracting credential, get `credential.identityToken` (Data) and decode to String
   - Call new `appleSignIn` method with `identityToken`, `nonce: currentNonce`, email, name
   - Clear `currentNonce` after use

4. **Remove `login` and `signup` methods entirely** — per user decision, Apple Sign In is the only auth option. No email/password.

5. **Add token refresh:**
   - `refreshTokenIfNeeded()` — Decode JWT payload (base64 middle segment), check `exp` claim. If expiring within 24 hours, call `api.refreshToken()`. On success, save new token to Keychain. On failure, keep existing token (don't force logout).
   - Call `refreshTokenIfNeeded()` at the end of `restoreSession()` after successful profile load.

6. **Add retry logic for sign-in:**
   - In the Apple Sign In completion handler, if the API call fails, retry up to 2 more times with 1-second delay between attempts
   - If all retries fail, set `errorMessage = "Something went wrong. Try again."`

**DriverAPIClient.swift** — Update the API client:

1. **Update `appleSignIn` method** to accept `identityToken: String` and `nonce: String?` in addition to existing params. Send body: `{ "identity_token": identityToken, "nonce": nonce, "userIdentifier": userIdentifier, "email": email, "name": name }`. Update the `AppleSignInRequest` model accordingly.

2. **Add `refreshToken()` method:** POST to `/api/auth/refresh` with authenticated: true. Returns `AuthRefreshResponse { success: Bool, token: String }`.

3. **Add silent token refresh on 401:** In the core `request` method, when a 401 is received, attempt one token refresh via `refreshToken()`. If refresh succeeds, save new token to Keychain and retry the original request once. If refresh also fails, throw `.unauthorized`.

4. **Remove `login` and `signup` methods** — no longer needed since only Apple Sign In is used.

**AuthModels.swift** — Update models:

1. **Update `AppleSignInRequest`** to include `identityToken: String?` and `nonce: String?` fields with CodingKeys mapping to `identity_token` and `nonce`.
2. **Add `AuthRefreshResponse`**: `{ success: Bool, token: String }`
3. **Remove `LoginRequest` and `SignupRequest`** — no longer used.
  </action>
  <verify>
Build: `xcodebuild build -project JunkOS-Driver/JunkOS-Driver.xcodeproj -scheme JunkOS-Driver -destination 'platform=iOS Simulator,name=iPhone 16' -quiet 2>&1 | tail -5`. Should compile without errors.
Grep nonce: `grep -c "nonce" JunkOS-Driver/Managers/AuthenticationManager.swift` should return > 0.
Grep no login/signup: `grep -c "func login\|func signup" JunkOS-Driver/Managers/AuthenticationManager.swift` should return 0.
  </verify>
  <done>
Driver AuthenticationManager sends identity_token + nonce with Apple Sign In. Token refresh on session restore and on 401. Email login/signup methods removed from AuthenticationManager and DriverAPIClient. AppleSignInRequest model updated with identity_token and nonce fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create driver onboarding screens and simplify auth UI to Apple-only</name>
  <files>
    JunkOS-Driver/Views/Auth/DriverOnboardingView.swift
    JunkOS-Driver/Views/Auth/DriverAuthView.swift
    JunkOS-Driver/JunkOSDriverApp.swift
  </files>
  <action>
**DriverOnboardingView.swift** — Create new file. 3-screen swipeable onboarding shown on first launch only:

Per user decisions:
- Screen 1: "Get jobs nearby" — SF Symbol `mappin.and.ellipse` or `location.magnifyingglass`, brief text about seeing jobs in your area
- Screen 2: "Set your schedule" — SF Symbol `calendar.badge.clock`, brief text about flexible scheduling
- Screen 3: "Earn on your terms" — SF Symbol `dollarsign.circle`, brief text about earning potential

Implementation:
- Use `TabView` with `PageTabViewStyle(indexDisplayMode: .always)` — native iOS dot indicators at bottom, swipeable
- `@AppStorage("hasCompletedDriverOnboarding")` to track first launch
- Each page: SF Symbol icon in a circle with `driverPrimary` color gradient background, title, subtitle
- Use driver design system: `DriverTypography`, `DriverSpacing`, `Color.driverPrimary`, `Color.driverBackground`
- "Get Started" button on last page (or "Next" / "Get Started" pattern)
- "Skip" text button in top-right
- Clean white/light background — NOT the red gradient (that's for splash only)
- On completion, set `hasCompletedDriverOnboarding = true` and transition to auth screen
- Respect `@Environment(\.accessibilityReduceMotion)` — skip animations if enabled

**DriverAuthView.swift** — Simplify to Apple Sign In only:

Per user decisions: same layout for both apps — logo/wordmark at top, "Sign in with Apple" button centered, clean background with red accent.

- Remove "Sign In with Email" button and "Create Account" button
- Remove `showLogin` and `showSignup` state variables
- Remove `navigationDestination` for DriverLoginView and DriverSignupView
- Keep only the hero section (Umuve Pro branding) and `SignInWithAppleButton`
- Add error message display: if `appState.auth.errorMessage` is non-nil, show inline error text below the Apple button in red: "Something went wrong. Try again." per user decisions
- Add loading indicator: if `appState.auth.isLoading`, show a `ProgressView()` overlay
- Layout: Clean `Color.driverBackground` background, "Umuve Pro" wordmark with truck icon at top center, "Sign in with Apple" button in lower portion, centered

**JunkOSDriverApp.swift** — Update entry point to include onboarding:

- Add `@AppStorage("hasCompletedDriverOnboarding") private var hasCompletedOnboarding = false`
- In the `Group` body, add onboarding check BEFORE the auth check:
  ```
  if showingSplash { SplashView... }
  else if !hasCompletedOnboarding { DriverOnboardingView() }
  else if !appState.auth.isAuthenticated { DriverAuthView(appState: appState) }
  else if ... (existing registration/role flow)
  ```
- The onboarding view sets `hasCompletedDriverOnboarding = true` when completed, which transitions to auth
- Remove any navigation to DriverLoginView or DriverSignupView if referenced
  </action>
  <verify>
Build: `xcodebuild build -project JunkOS-Driver/JunkOS-Driver.xcodeproj -scheme JunkOS-Driver -destination 'platform=iOS Simulator,name=iPhone 16' -quiet 2>&1 | tail -5`. Should compile without errors.
Grep onboarding: `grep -c "hasCompletedDriverOnboarding" JunkOS-Driver/JunkOSDriverApp.swift` should return > 0.
Grep no email buttons: `grep -c "Sign In with Email\|Create Account" JunkOS-Driver/Views/Auth/DriverAuthView.swift` should return 0.
File exists: `ls JunkOS-Driver/Views/Auth/DriverOnboardingView.swift` should succeed.
  </verify>
  <done>
3-screen driver onboarding (Get jobs nearby, Set your schedule, Earn on your terms) with PageTabViewStyle dots, shown on first launch only. DriverAuthView shows only Apple Sign In button with Umuve Pro branding, inline error display, and loading state. App entry point routes: Splash -> Onboarding (first launch) -> Sign In -> Registration -> Main.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild build -project JunkOS-Driver/JunkOS-Driver.xcodeproj -scheme JunkOS-Driver -destination 'platform=iOS Simulator,name=iPhone 16' -quiet` succeeds
2. `grep "nonce" JunkOS-Driver/Managers/AuthenticationManager.swift` returns matches
3. `grep "identity_token" JunkOS-Driver/Services/DriverAPIClient.swift` returns matches
4. `grep "hasCompletedDriverOnboarding" JunkOS-Driver/JunkOSDriverApp.swift` returns matches
5. `ls JunkOS-Driver/Views/Auth/DriverOnboardingView.swift` exists
6. `grep -c "Sign In with Email" JunkOS-Driver/Views/Auth/DriverAuthView.swift` returns 0
7. `grep -c "func login\|func signup" JunkOS-Driver/Managers/AuthenticationManager.swift` returns 0
</verification>

<success_criteria>
- Driver app sends identity_token + nonce with Apple Sign In
- Driver app shows 3 onboarding screens on first launch only
- Driver auth screen shows only "Sign in with Apple" button — no email/password
- Error message displays inline below button on failure
- Token refresh works silently on session restore
- App flow: Splash -> Onboarding (first launch) -> Sign In -> Registration -> Main tabs
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-02-SUMMARY.md`
</output>
